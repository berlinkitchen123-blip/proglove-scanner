<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ProGlove Scanner - Samsung Fix</title>
    <style>
        /* COMPATIBILITY FIXES FOR SAMSUNG TAB */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; /* Remove blue tap highlight */
            -webkit-touch-callout: none; /* Disable callout */
        }
        
        body { 
            font-family: 'Arial', 'Helvetica', sans-serif; 
            background: #1a1a1a; 
            color: white; 
            padding: 10px;
            -webkit-text-size-adjust: 100%; /* Prevent text zoom */
            touch-action: manipulation; /* Better touch handling */
        }
        
        .container { 
            max-width: 100%; 
            margin: 0 auto; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
        }
        
        /* LARGER TOUCH TARGETS FOR SAMSUNG */
        .sync-btn, .mode-btn, .scan-btn {
            min-height: 50px; /* Larger touch targets */
            font-size: 18px; /* Larger text */
            cursor: pointer;
        }
        
        .dropdown {
            min-height: 50px;
            font-size: 18px;
        }
        
        .proglove-input {
            min-height: 60px;
            font-size: 20px;
        }
        
        /* REST OF YOUR EXISTING STYLES... */
        .header { background: #4285f4; padding: 15px; text-align: center; border-radius: 10px; }
        .card { background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .sync-section { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .sync-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .sync-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; }
        .download-btn { background: #4285f4; color: white; }
        .upload-btn { background: #34a853; color: white; }
        .export-btn { background: #f57c00; color: white; }
        .emergency-btn { background: #ea4335; color: white; }
        .sync-btn:disabled { background: #666; cursor: not-allowed; }
        .system-status { padding: 10px; margin-top: 10px; border-radius: 5px; text-align: center; font-size: 12px; background: #444; border-left: 4px solid #f57c00; }
        .sync-status { padding: 10px; margin-top: 10px; border-radius: 5px; text-align: center; font-size: 12px; background: #444; border-left: 4px solid #4285f4; }
        .sync-status.success { border-left-color: #34a853; background: #2a2a2a; }
        .sync-status.error { border-left-color: #ea4335; background: #2a2a2a; }
        .mode-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }
        .kitchen-btn { background: #34a853; color: white; }
        .return-btn { background: #ea4335; color: white; }
        .mode-btn.active { box-shadow: 0 0 0 3px white; }
        .dropdown { width: 100%; padding: 12px; background: #444; color: white; border: 2px solid #666; border-radius: 6px; margin-top: 10px; }
        .scan-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .scan-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-weight: bold; }
        .start-btn { background: #34a853; color: white; }
        .stop-btn { background: #ea4335; color: white; }
        .scan-btn:disabled { background: #666; cursor: not-allowed; }
        .proglove-input { width: 100%; padding: 15px; background: #333; color: white; border: 2px solid #666; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .proglove-input.error { border-color: #ea4335; animation: shake 0.5s; }
        .scanning-active { animation: pulse 1.5s infinite; border: 3px solid #34a853; }
        .feedback { padding: 12px; margin-top: 10px; border-radius: 6px; text-align: center; font-weight: bold; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .success { background: #34a853; }
        .error { background: #ea4335; }
        .warning { background: #f57c00; }
        .info { background: #4285f4; }
        .hidden { display: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #333; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .kitchen-stat { color: #34a853; }
        .return-stat { color: #ea4335; }
        .active-stat { color: #4285f4; }
        .prep-stat { color: #f57c00; }
        .response-time { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
        .local-data { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #f57c00; }
        .upload-info { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #4285f4; }
        .cross-team-data { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #f57c00; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .data-label { font-weight: bold; }
        .admin-section { border: 2px solid #f57c00; }
        .backup-status { background: #2a2a2a; padding: 8px; border-radius: 5px; margin-top: 5px; font-size: 11px; border-left: 4px solid #34a853; }
        .device-lock { background: #ff9800; padding: 8px; border-radius: 5px; margin-top: 5px; font-size: 11px; border-left: 4px solid #ff9800; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(52, 168, 83, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß§ ProGlove Scanner - Samsung Fix</h1>
            <p>Multi-Device ‚Ä¢ Cross-Browser Compatible</p>
        </div>
        
        <div class="card">
            <h3>üìä SYSTEM STATUS</h3>
            <div class="system-status" id="systemStatus">
                üîÑ Connecting to cloud...
            </div>
            <div class="backup-status" id="backupStatus">
                üíæ Sync active
            </div>
            <div class="device-lock" id="deviceLockStatus">
                üîì No active scanner
            </div>
            <!-- DEBUG INFO FOR SAMSUNG -->
            <div class="local-data" id="debugInfo" style="border-left-color: #4285f4;">
                <strong>Device Info:</strong> <span id="deviceInfo">Detecting...</span>
            </div>
        </div>

        <div class="card">
            <h3>üì± SELECT MODE</h3>
            <div class="mode-buttons">
                <button class="mode-btn kitchen-btn" onclick="setMode('kitchen')" id="kitchenBtn">üç≥ KITCHEN</button>
                <button class="mode-btn return-btn" onclick="setMode('return')" id="returnBtn">üîÑ RETURN</button>
            </div>
        </div>
        
        <div class="card">
            <h3>üë§ SELECT USER</h3>
            <select class="dropdown" id="userDropdown" onchange="selectUser()">
                <option value="">-- Select User --</option>
            </select>
            <div class="local-data" id="userSelectionInfo" style="display: none;">
                <strong>Selected:</strong> <span id="selectedUser">None</span>
            </div>
        </div>
        
        <div class="card hidden" id="dishSection">
            <h3>üìù SELECT DISH LETTER</h3>
            <select class="dropdown" id="dishDropdown" onchange="selectDishLetter()">
                <option value="">-- Select Dish Letter --</option>
            </select>
        </div>
        
        <div class="card" id="scanSection">
            <h3>üîç SCANNING CONTROLS</h3>
            <div class="scan-controls">
                <button class="scan-btn start-btn" id="startBtn" onclick="requestScanningAccess()">‚ñ∂ START SCANNING</button>
                <button class="scan-btn stop-btn" id="stopBtn" onclick="stopScanning()">‚èπ STOP SCANNING</button>
            </div>
            
            <!-- SCANNING STATUS INFO -->
            <div class="local-data" id="scanStatusInfo" style="border-left-color: #34a853;">
                <strong>Scanning Status:</strong> <span id="scanStatusText">Ready to start</span>
            </div>
            
            <input type="text" class="proglove-input" id="progloveInput" placeholder="Click START SCANNING to begin..." disabled>
            
            <div class="response-time">
                Response time: <span id="responseTimeValue">0</span>ms ‚Ä¢ 
                Timeout: <span id="timeoutCounter">120</span>s
            </div>
            
            <div class="feedback info" id="feedback">
                ‚úÖ System ready - Select mode and user to start
            </div>
        </div>

        <!-- TROUBLESHOOTING SECTION FOR SAMSUNG -->
        <div class="card" style="border: 2px solid #4285f4;">
            <h3>üîß SAMSUNG TAB TROUBLESHOOTING</h3>
            <div class="sync-controls">
                <button class="sync-btn download-btn" onclick="forceRefresh()" id="refreshBtn">
                    üîÑ FORCE REFRESH
                </button>
                <button class="sync-btn emergency-btn" onclick="clearAllData()" id="clearBtn">
                    üóëÔ∏è CLEAR ALL DATA
                </button>
            </div>
            <div class="local-data">
                <strong>If Start Scanning doesn't appear:</strong>
                <br>1. Select Mode ‚Üí Select User
                <br>2. Wait 3 seconds for lock check
                <br>3. Click FORCE REFRESH if stuck
                <br>4. Use CLEAR ALL DATA as last resort
            </div>
        </div>

        <!-- REST OF YOUR EXISTING HTML... -->
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        // SAMSUNG COMPATIBLE FIREBASE INIT
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get, update } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCL3hffCHosBceIRGR1it2dYEDb3uxIrJw",
            authDomain: "proglove-scanner.firebaseapp.com",
            databaseURL: "https://proglove-scanner-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "proglove-scanner",
            storageBucket: "proglove-scanner.firebasestorage.app",
            messagingSenderId: "177575768177",
            appId: "1:177575768177:web:0a0acbf222218e0c0b2bd0"
        };

        let app;
        let database;
        let deviceId = 'samsung_' + Math.random().toString(36).substr(2, 9);
        let isSamsungDevice = false;

        // DETECT SAMSUNG DEVICE
        function detectSamsungDevice() {
            const userAgent = navigator.userAgent.toLowerCase();
            isSamsungDevice = userAgent.includes('samsung') || 
                             userAgent.includes('sm-') || 
                             /android.*samsung/i.test(userAgent);
            
            document.getElementById('deviceInfo').textContent = 
                isSamsungDevice ? 'Samsung Tablet Detected' : 'Other Device';
            
            console.log('üì± Device detected:', {
                userAgent: navigator.userAgent,
                isSamsung: isSamsungDevice,
                deviceId: deviceId
            });
        }

        // IMPROVED DEVICE LOCKING WITH SAMSUNG SUPPORT
        class DeviceLockSystem {
            constructor() {
                this.lockCheckInterval = null;
                this.isLocked = false;
            }

            async requestLock() {
                if (!database) {
                    console.log('‚ö†Ô∏è Firebase not available - allowing scan without lock');
                    return true;
                }

                try {
                    const lockRef = ref(database, 'deviceLock');
                    const snapshot = await get(lockRef);
                    const currentLock = snapshot.val();

                    // If no lock or lock expired
                    if (!currentLock || this.isLockExpired(currentLock)) {
                        const lockData = {
                            deviceId: deviceId,
                            user: window.appData.user,
                            timestamp: Date.now(),
                            mode: window.appData.mode,
                            dishLetter: window.appData.dishLetter,
                            deviceType: isSamsungDevice ? 'samsung' : 'other'
                        };

                        await set(lockRef, lockData);
                        this.isLocked = true;
                        this.startLockMonitoring();
                        console.log('üîí Lock acquired by Samsung device');
                        return true;
                    } else if (currentLock.deviceId === deviceId) {
                        // We already have the lock
                        console.log('üîí Lock already held by this device');
                        return true;
                    } else {
                        console.log('üîê Lock held by another device:', currentLock.deviceId);
                        return false;
                    }
                } catch (error) {
                    console.error('‚ùå Lock request failed:', error);
                    // On Samsung devices, allow scanning even if lock fails
                    return true;
                }
            }

            isLockExpired(lock) {
                return Date.now() - lock.timestamp > 130000; // 2 minutes 10 seconds
            }

            startLockMonitoring() {
                this.lockCheckInterval = setInterval(() => {
                    if (!database) return;
                    
                    const lockRef = ref(database, 'deviceLock');
                    onValue(lockRef, (snapshot) => {
                        const lock = snapshot.val();
                        this.updateLockDisplay(lock);
                    });
                }, 3000); // Faster checking for Samsung
            }

            updateLockDisplay(lock) {
                const lockStatus = document.getElementById('deviceLockStatus');
                const startBtn = document.getElementById('startBtn');
                const scanStatus = document.getElementById('scanStatusText');
                
                if (!lock) {
                    lockStatus.innerHTML = 'üîì No active scanner';
                    lockStatus.style.borderLeftColor = '#34a853';
                    startBtn.disabled = !canStartScanning();
                    scanStatus.textContent = 'Ready to start scanning';
                } else if (lock.deviceId === deviceId) {
                    const timeElapsed = Math.floor((Date.now() - lock.timestamp) / 1000);
                    lockStatus.innerHTML = `üîí You are scanning ‚Ä¢ ${120 - timeElapsed}s left`;
                    lockStatus.style.borderLeftColor = '#4285f4';
                    startBtn.disabled = true;
                    startBtn.textContent = '‚ñ∂ YOU ARE SCANNING';
                    scanStatus.textContent = 'You are currently scanning';
                } else {
                    const timeSinceActivity = Math.floor((Date.now() - lock.timestamp) / 1000);
                    lockStatus.innerHTML = `üîê ${lock.user} is scanning ‚Ä¢ ${120 - timeSinceActivity}s left`;
                    lockStatus.style.borderLeftColor = '#ff9800';
                    startBtn.disabled = true;
                    startBtn.textContent = `‚è∏Ô∏è ${lock.user} IS SCANNING`;
                    scanStatus.textContent = `${lock.user} is currently scanning`;
                    
                    // Auto-release if lock expired
                    if (this.isLockExpired(lock)) {
                        this.forceReleaseLock();
                    }
                }
                
                // FORCE ENABLE START BUTTON AFTER 5 SECONDS ON SAMSUNG (Safety net)
                if (isSamsungDevice && startBtn.disabled) {
                    setTimeout(() => {
                        if (startBtn.disabled && !window.appData.scanning) {
                            console.log('üîÑ Samsung safety net - enabling start button');
                            startBtn.disabled = !canStartScanning();
                            startBtn.textContent = '‚ñ∂ START SCANNING';
                        }
                    }, 5000);
                }
            }

            async forceReleaseLock() {
                if (!database) return;
                try {
                    const lockRef = ref(database, 'deviceLock');
                    await set(lockRef, null);
                    this.isLocked = false;
                    console.log('üîì Lock force released');
                } catch (error) {
                    console.error('Force release failed:', error);
                }
            }
        }

        const deviceLock = new DeviceLockSystem();

        function initializeFirebase() {
            try {
                detectSamsungDevice();
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                setupFirebaseListeners();
                
                setTimeout(() => {
                    showMessage('‚úÖ Firebase Connected ‚Ä¢ Samsung Optimized', 'success');
                    document.getElementById('systemStatus').textContent = '‚úÖ Firebase Connected ‚Ä¢ Samsung Optimized';
                }, 1000);
                
            } catch (error) {
                console.log('Firebase initialization failed:', error);
                showMessage('‚ö†Ô∏è Offline mode - Limited functionality', 'warning');
                document.getElementById('systemStatus').textContent = '‚ö†Ô∏è Offline mode - Limited functionality';
            }
        }

        function setupFirebaseListeners() {
            if (!database) return;

            // Listen for app data
            const appDataRef = ref(database, 'appData');
            onValue(appDataRef, (snapshot) => {
                const firebaseAppData = snapshot.val();
                if (firebaseAppData) {
                    window.appData.activeBowls = firebaseAppData.activeBowls || [];
                    window.appData.preparedBowls = firebaseAppData.preparedBowls || [];
                    window.appData.returnedBowls = firebaseAppData.returnedBowls || [];
                    window.appData.myScans = firebaseAppData.myScans || [];
                    window.appData.scanHistory = firebaseAppData.scanHistory || [];
                    
                    updateDisplay();
                    saveToStorage();
                }
            });

            // Listen for device lock
            const lockRef = ref(database, 'deviceLock');
            onValue(lockRef, (snapshot) => {
                const lock = snapshot.val();
                deviceLock.updateLockDisplay(lock);
            });
        }

        window.initializeFirebase = initializeFirebase;
        window.deviceLock = deviceLock;
    </script>

    <!-- SAMSUNG-OPTIMIZED APPLICATION LOGIC -->
    <script>
        // ProGlove Scanner - SAMSUNG OPTIMIZED
        window.appData = {
            mode: null,
            user: null,
            dishLetter: null,
            scanning: false,
            myScans: [],
            activeBowls: [],
            preparedBowls: [],
            returnedBowls: [],
            scanHistory: [],
            expectedCounts: {},
            lastActivity: Date.now()
        };

        const USERS = [
            {name: "Hamid", role: "Kitchen"},
            {name: "Richa", role: "Kitchen"},
            {name: "Mary", role: "Kitchen"},
            {name: "Jash", role: "Kitchen"},
            {name: "Joel", role: "Kitchen"},
            {name: "Rushal", role: "Kitchen"},
            {name: "Sreekanth", role: "Kitchen"},
            {name: "M.Sultan", role: "Return"},
            {name: "Riyaz", role: "Return"},
            {name: "Alan", role: "Return"},
            {name: "Aadesh", role: "Return"},
            {name: "Kitchen Team", role: "Return"}
        ];

        // SAMSUNG COMPATIBILITY FUNCTIONS
        function forceRefresh() {
            console.log('üîÑ Force refreshing Samsung device');
            window.location.reload(true);
        }

        function clearAllData() {
            console.log('üóëÔ∏è Clearing all data on Samsung device');
            localStorage.clear();
            sessionStorage.clear();
            window.appData = {
                mode: null, user: null, dishLetter: null, scanning: false,
                myScans: [], activeBowls: [], preparedBowls: [], returnedBowls: [], scanHistory: []
            };
            showMessage('‚úÖ All data cleared - refreshing page', 'success');
            setTimeout(forceRefresh, 2000);
        }

        // Initialize with Samsung optimizations
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Initializing Samsung-optimized scanner...');
            initializeFirebase();
            loadFromStorage();
            initializeUsers();
            updateDisplay();
            
            // Samsung-specific event listeners
            document.getElementById('progloveInput').addEventListener('input', handleScanInput);
            document.addEventListener('click', resetTimeoutTimer);
            document.addEventListener('touchstart', resetTimeoutTimer); // Added for touch devices
            document.addEventListener('keydown', resetTimeoutTimer);
            
            // Auto-enable start button after 3 seconds (Samsung workaround)
            setTimeout(() => {
                const startBtn = document.getElementById('startBtn');
                if (startBtn.disabled && !window.appData.scanning) {
                    startBtn.disabled = !canStartScanning();
                    console.log('üîÑ Samsung auto-enable check completed');
                }
            }, 3000);
        });

        // Storage functions
        function saveToStorage() {
            try {
                localStorage.setItem('proglove_data', JSON.stringify(window.appData));
            } catch (error) {
                console.log('Storage save error:', error);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('proglove_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    window.appData = { ...window.appData, ...data };
                    console.log('Data loaded from storage');
                }
            } catch (error) {
                console.log('No previous data found');
            }
        }

        // User and Mode Management
        function initializeUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            USERS.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name + (user.role ? ` (${user.role})` : '');
                dropdown.appendChild(option);
            });
        }

        function setMode(mode) {
            window.appData.mode = mode;
            window.appData.user = null;
            window.appData.dishLetter = null;
            window.appData.scanning = false;
            
            document.getElementById('kitchenBtn').classList.toggle('active', mode === 'kitchen');
            document.getElementById('returnBtn').classList.toggle('active', mode === 'return');
            
            document.getElementById('dishSection').classList.toggle('hidden', mode !== 'kitchen');
            document.getElementById('userDropdown').value = '';
            document.getElementById('dishDropdown').value = '';
            document.getElementById('progloveInput').value = '';
            
            loadUsers();
            updateStatsLabels();
            updateDisplay();
            showMessage(`üì± ${mode.toUpperCase()} mode selected`, 'info');
            
            // Samsung: Force UI update
            setTimeout(updateDisplay, 100);
        }

        function canStartScanning() {
            const canStart = window.appData.user && 
                           (!window.appData.scanning) &&
                           (window.appData.mode !== 'kitchen' || window.appData.dishLetter);
            
            console.log('üîç Can start scanning check:', {
                user: window.appData.user,
                scanning: window.appData.scanning,
                mode: window.appData.mode,
                dishLetter: window.appData.dishLetter,
                canStart: canStart
            });
            
            return canStart;
        }

        // REQUEST SCANNING ACCESS - SAMSUNG OPTIMIZED
        async function requestScanningAccess() {
            console.log('üéØ Samsung device requesting scan access...');
            
            if (!canStartScanning()) {
                showMessage('‚ùå Please select user and dish letter first', 'error');
                // Show debug info
                document.getElementById('userSelectionInfo').style.display = 'block';
                document.getElementById('selectedUser').textContent = window.appData.user || 'None';
                return;
            }

            const lockAcquired = await deviceLock.requestLock();
            if (lockAcquired) {
                startScanning();
            } else {
                showMessage('‚è∏Ô∏è Another device is scanning. Wait 5 seconds...', 'warning');
                // Auto-retry for Samsung
                setTimeout(() => {
                    if (!window.appData.scanning) {
                        console.log('üîÑ Samsung auto-retry scan access');
                        requestScanningAccess();
                    }
                }, 5000);
            }
        }

        function startScanning() {
            window.appData.scanning = true;
            updateDisplay();
            document.getElementById('progloveInput').focus();
            showMessage(`üéØ SCANNING ACTIVE - Samsung Ready`, 'success');
        }

        async function stopScanning() {
            if (!window.appData.scanning) {
                showMessage('‚ÑπÔ∏è Scanning is not active', 'info');
                return;
            }
            
            console.log('üõë Samsung device stopping scan');
            window.appData.scanning = false;
            await deviceLock.releaseLock();
            updateDisplay();
            syncToFirebase();
            showMessage(`‚èπ Scanning stopped ‚Ä¢ Data saved`, 'success');
        }

        function selectUser() {
            const dropdown = document.getElementById('userDropdown');
            window.appData.user = dropdown.value;
            
            if (window.appData.user) {
                showMessage(`‚úÖ ${window.appData.user} selected`, 'success');
                document.getElementById('userSelectionInfo').style.display = 'block';
                document.getElementById('selectedUser').textContent = window.appData.user;
                
                if (window.appData.mode === 'kitchen') {
                    document.getElementById('dishSection').classList.remove('hidden');
                    loadDishLetters();
                }
            }
            updateDisplay();
            
            // Samsung: Force button state update
            setTimeout(() => {
                document.getElementById('startBtn').disabled = !canStartScanning();
            }, 100);
        }

        function selectDishLetter() {
            const dropdown = document.getElementById('dishDropdown');
            window.appData.dishLetter = dropdown.value;
            
            if (window.appData.dishLetter) {
                showMessage(`üìù Dish ${window.appData.dishLetter} selected`, 'success');
            }
            updateDisplay();
            
            // Samsung: Force button state update
            setTimeout(() => {
                document.getElementById('startBtn').disabled = !canStartScanning();
            }, 100);
        }

        // ... REST OF YOUR EXISTING FUNCTIONS (handleScanInput, processScan, kitchenScan, returnScan, etc.)

        function loadUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            let usersToShow = [];
            if (window.appData.mode === 'kitchen') {
                usersToShow = USERS.filter(user => user.role === 'Kitchen');
            } else if (window.appData.mode === 'return') {
                usersToShow = USERS.filter(user => user.role === 'Return' || user.name === "Kitchen Team");
            }
            
            usersToShow.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name + (user.role ? ` (${user.role})` : '');
                dropdown.appendChild(option);
            });
        }

        function loadDishLetters() {
            const dropdown = document.getElementById('dishDropdown');
            dropdown.innerHTML = '<option value="">-- Select Dish Letter --</option>';
            
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = letter;
                dropdown.appendChild(option);
            });
        }

        function handleScanInput(e) {
            if (!window.appData.scanning) return;
            
            const scanValue = e.target.value.trim();
            if (scanValue.length >= 2) {
                processScan(scanValue);
                setTimeout(() => e.target.value = '', 100);
            }
        }

        function processScan(code) {
            // Your existing scan processing logic
            console.log('üì¶ Scan processed:', code);
            showMessage(`‚úÖ Scanned: ${code}`, 'success');
            // Add your kitchenScan/returnScan logic here
        }

        function syncToFirebase() {
            if (!database) return;
            // Your existing Firebase sync logic
            console.log('‚òÅÔ∏è Data synced to Firebase');
        }

        function updateDisplay() {
            const startBtn = document.getElementById('startBtn');
            startBtn.disabled = !canStartScanning();
            
            // Update other display elements...
        }

        function showMessage(text, type) {
            const element = document.getElementById('feedback');
            element.textContent = text;
            element.className = 'feedback ' + type;
        }

        function updateStatsLabels() {
            const prepLabel = document.getElementById('prepLabel');
            if (window.appData.mode === 'kitchen') {
                prepLabel.textContent = 'Prepared Today';
            } else {
                prepLabel.textContent = 'Returned Today';
            }
        }

        // Make functions globally available
        window.forceRefresh = forceRefresh;
        window.clearAllData = clearAllData;
        window.forceReleaseLock = () => deviceLock.forceReleaseLock();
    </script>
</body>
</html>
