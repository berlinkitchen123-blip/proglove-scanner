<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGlove Scanner - Complete System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px; min-height: 100vh; }
        .container { max-width: 100%; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        
        .header { 
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            padding: 20px; 
            text-align: center; 
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .card { 
            background: linear-gradient(135deg, #2c3e50, #34495e);
            padding: 20px; 
            border-radius: 15px; 
            margin-bottom: 10px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .sync-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .sync-btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .download-btn { background: linear-gradient(45deg, #3498db, #2980b9); color: white; }
        .upload-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; }
        .export-btn { background: linear-gradient(45deg, #e67e22, #d35400); color: white; }
        .backup-btn { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
        .sync-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .sync-btn:disabled { background: #7f8c8d; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .system-status { 
            padding: 15px; 
            margin-top: 10px; 
            border-radius: 10px; 
            text-align: center; 
            font-size: 14px; 
            background: linear-gradient(45deg, #e67e22, #f39c12);
            border-left: 4px solid #f1c40f;
            font-weight: bold;
        }
        
        .mode-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .kitchen-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; }
        .return-btn { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
        .mode-btn.active { box-shadow: 0 0 0 3px #f1c40f, 0 0 20px rgba(241, 196, 15, 0.5); transform: scale(1.02); }
        .mode-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        
        .dropdown { 
            width: 100%; 
            padding: 15px; 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white; 
            border: 2px solid #3498db; 
            border-radius: 10px; 
            font-size: 16px; 
            margin-top: 10px; 
        }
        
        .scan-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .scan-btn { flex: 1; padding: 18px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; }
        .start-btn { background: linear-gradient(45deg, #27ae60, #2ecc71); color: white; }
        .stop-btn { background: linear-gradient(45deg, #e74c3c, #c0392b); color: white; }
        .scan-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .scan-btn:disabled { background: #7f8c8d; cursor: not-allowed; transform: none; box-shadow: none; }
        
        .proglove-input { 
            width: 100%; 
            padding: 18px; 
            font-size: 18px; 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white; 
            border: 3px solid #3498db; 
            border-radius: 12px; 
            margin-bottom: 15px; 
            text-align: center; 
            transition: all 0.3s ease;
        }
        .proglove-input:focus { border-color: #f1c40f; box-shadow: 0 0 20px rgba(241, 196, 15, 0.5); }
        .proglove-input.error { border-color: #e74c3c; animation: shake 0.5s; background: linear-gradient(135deg, #c0392b, #e74c3c); }
        .scanning-active { animation: pulse 1.5s infinite; border: 3px solid #27ae60; box-shadow: 0 0 30px rgba(39, 174, 96, 0.5); }
        
        .feedback { 
            padding: 15px; 
            margin-top: 10px; 
            border-radius: 10px; 
            text-align: center; 
            font-weight: bold; 
            min-height: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .success { background: linear-gradient(45deg, #27ae60, #2ecc71); }
        .error { background: linear-gradient(45deg, #e74c3c, #c0392b); }
        .warning { background: linear-gradient(45deg, #e67e22, #f39c12); }
        .info { background: linear-gradient(45deg, #3498db, #2980b9); }
        
        .hidden { display: none; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 20px; 
            border-radius: 12px; 
            text-align: center;
            border: 2px solid rgba(255,255,255,0.1);
        }
        .stat-value { font-size: 28px; font-weight: bold; margin: 10px 0; }
        .kitchen-stat { color: #2ecc71; }
        .return-stat { color: #e74c3c; }
        .active-stat { color: #3498db; }
        .prep-stat { color: #f39c12; }
        
        .response-time { 
            font-size: 14px; 
            color: #bdc3c7; 
            text-align: center; 
            margin-top: 5px; 
            font-weight: bold;
        }
        
        .local-data { 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 10px; 
            font-size: 12px; 
            border-left: 4px solid #f39c12;
        }
        
        .upload-info { 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 10px; 
            font-size: 12px; 
            border-left: 4px solid #3498db;
        }
        
        .cross-team-data { 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 12px; 
            border-radius: 8px; 
            margin-top: 10px; 
            font-size: 12px; 
            border-left: 4px solid #f39c12;
        }
        
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .data-label { font-weight: bold; color: #f1c40f; }
        
        .admin-section { border: 3px solid #f39c12; background: linear-gradient(135deg, #2c3e50, #34495e); }
        
        .backup-status { 
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            padding: 10px; 
            border-radius: 8px; 
            margin-top: 5px; 
            font-size: 12px; 
            border-left: 4px solid #2ecc71;
            font-weight: bold;
        }
        
        /* Table Styles */
        .data-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px;
            font-size: 12px;
            border-radius: 10px;
            overflow: hidden;
        }
        .data-table th {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 8px;
            text-align: center;
            border: 1px solid #2c3e50;
            font-weight: bold;
        }
        .data-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #2c3e50;
            background: linear-gradient(135deg, #34495e, #2c3e50);
        }
        .dish-header { 
            background: linear-gradient(45deg, #27ae60, #2ecc71) !important; 
            font-weight: bold; 
            color: white;
        }
        
        /* JSON Upload */
        .json-upload { 
            background: linear-gradient(135deg, #34495e, #2c3e50);
            padding: 15px; 
            border-radius: 10px; 
            margin: 10px 0; 
            border: 2px solid #3498db;
        }
        .json-textarea { 
            width: 100%; 
            height: 120px; 
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white; 
            border: 2px solid #3498db; 
            border-radius: 8px; 
            padding: 10px; 
            font-family: monospace; 
            font-size: 12px; 
            resize: vertical;
        }
        
        @keyframes pulse { 
            0% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0.7); } 
            70% { box-shadow: 0 0 0 20px rgba(39, 174, 96, 0); } 
            100% { box-shadow: 0 0 0 0 rgba(39, 174, 96, 0); } 
        }
        @keyframes shake { 
            0%, 100% { transform: translateX(0); } 
            25% { transform: translateX(-8px); } 
            75% { transform: translateX(8px); } 
        }
        
        h3 { color: #f1c40f; margin-bottom: 15px; font-size: 18px; }
        h1 { font-size: 24px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß§ ProGlove Scanner - Complete System</h1>
            <p>Real-time Tracking ‚Ä¢ Data Export ‚Ä¢ Daily Reset</p>
        </div>
        
        <div class="card">
            <h3>üìä SYSTEM STATUS</h3>
            <div class="system-status" id="systemStatus">
                üîÑ Connecting to cloud...
            </div>
            <div class="backup-status" id="backupStatus">
                üíæ Real-time sync active
            </div>
        </div>

        <div class="card">
            <h3>üì± SELECT MODE</h3>
            <div class="mode-buttons">
                <button class="mode-btn kitchen-btn" onclick="setMode('kitchen')" id="kitchenBtn">üç≥ KITCHEN</button>
                <button class="mode-btn return-btn" onclick="setMode('return')" id="returnBtn">üîÑ RETURN</button>
            </div>
        </div>
        
        <div class="card">
            <h3>üë§ SELECT USER</h3>
            <select class="dropdown" id="userDropdown" onchange="selectUser()">
                <option value="">-- Select User --</option>
            </select>
        </div>
        
        <div class="card hidden" id="dishSection">
            <h3>üìù SELECT DISH LETTER</h3>
            <select class="dropdown" id="dishDropdown" onchange="selectDishLetter()">
                <option value="">-- Select Dish Letter --</option>
            </select>
        </div>
        
        <!-- SCANNING SECTION -->
        <div class="card" id="scanSection">
            <h3>üîç SCANNING CONTROLS</h3>
            <div class="scan-controls">
                <button class="scan-btn start-btn" id="startBtn" onclick="startScanning()">‚ñ∂ START SCANNING</button>
                <button class="scan-btn stop-btn" id="stopBtn" onclick="stopScanning()" disabled>‚èπ STOP SCANNING</button>
            </div>
            
            <input type="text" class="proglove-input" id="progloveInput" placeholder="Click START SCANNING to begin..." disabled>
            
            <div class="response-time">
                Response time: <span id="responseTimeValue">0</span>ms
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Active Bowls</div>
                    <div class="stat-value active-stat" id="activeCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label" id="prepLabel">Prepared Today</div>
                    <div class="stat-value prep-stat" id="prepCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">My Scans Today</div>
                    <div class="stat-value kitchen-stat" id="myScansCount">0</div>
                </div>
            </div>
            
            <div class="feedback info" id="feedback">
                ‚úÖ System ready - Select mode and user to start
            </div>
        </div>

        <!-- OVERNIGHT STATISTICS TABLE -->
        <div class="card">
            <h3>üìà OVERNIGHT SCANNING STATISTICS (10PM-10AM)</h3>
            <div class="local-data">
                <strong>Cycle:</strong> <span id="cycleInfo">Today 10PM - Tomorrow 10AM</span>
            </div>
            <div id="overnightStats">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Dish</th>
                            <th>User</th>
                            <th>Bowls</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                        </tr>
                    </thead>
                    <tbody id="overnightStatsBody">
                        <tr><td colspan="5" style="text-align: center;">No overnight scans yet</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- DATA EXPORT SECTION -->
        <div class="card admin-section">
            <h3>üì§ DATA EXPORT</h3>
            <div class="sync-controls">
                <button class="sync-btn export-btn" onclick="exportActiveBowls()" id="exportActiveBtn">
                    üì• EXPORT ACTIVE BOWLS
                </button>
                <button class="sync-btn export-btn" onclick="exportReturnData()" id="exportReturnBtn">
                    üì• EXPORT RETURN DATA
                </button>
                <button class="sync-btn download-btn" onclick="exportAllData()" id="exportAllBtn">
                    üìä EXPORT ALL DATA
                </button>
            </div>
            <div class="local-data" id="exportInfo">
                <strong>Data Status:</strong> Active: 0 bowls ‚Ä¢ Prepared: 0 today ‚Ä¢ Returns: 0 today
            </div>
        </div>

        <!-- JSON DATA PASTE SECTION -->
        <div class="card">
            <h3>üìÅ PASTE CUSTOMER DATA (JSON)</h3>
            <div class="json-upload">
                <textarea class="json-textarea" id="jsonData" placeholder='Paste JSON data here (EXACT FORMAT):
[
  {
    "vyt_code": "https://vytal.io/VYT12345",
    "company": "Company Name", 
    "customer": "Customer Name",
    "dish": "A"
  }
]

Make sure VYT codes match exactly with scanned bowl codes!'></textarea>
                <div class="sync-controls">
                    <button class="sync-btn upload-btn" onclick="processJsonData()">üîÑ PATCH CUSTOMER DATA</button>
                    <button class="sync-btn backup-btn" onclick="document.getElementById('jsonData').value=''">üóëÔ∏è CLEAR</button>
                </div>
            </div>
            <div class="local-data" id="jsonStatus">
                <strong>JSON Status:</strong> No data loaded
            </div>
            <div class="local-data" id="patchResults" style="display: none;">
                <strong>Patch Results:</strong> <span id="patchSummary">Waiting for patch...</span>
                <div id="failedMatches" style="margin-top: 5px;"></div>
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCL3hffCHosBceIRGR1it2dYEDb3uxIrJw",
            authDomain: "proglove-scanner.firebaseapp.com",
            databaseURL: "https://proglove-scanner-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "proglove-scanner",
            storageBucket: "proglove-scanner.firebasestorage.app",
            messagingSenderId: "177575768177",
            appId: "1:177575768177:web:0a0acbf222218e0c0b2bd0"
        };

        let app;
        let database;

        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                setupFirebaseListeners();
                
                showMessage('‚úÖ Cloud connected ‚Ä¢ Real-time sync active', 'success');
                document.getElementById('systemStatus').textContent = '‚úÖ Cloud connected ‚Ä¢ Real-time sync active';
                
            } catch (error) {
                console.log('Firebase initialization failed:', error);
                showMessage('‚ö†Ô∏è Offline mode - scanning works locally', 'warning');
                document.getElementById('systemStatus').textContent = '‚ö†Ô∏è Offline mode - Scanning works locally';
            }
        }

        function setupFirebaseListeners() {
            if (!database) return;

            const appDataRef = ref(database, 'appData');
            onValue(appDataRef, (snapshot) => {
                const firebaseAppData = snapshot.val();
                if (firebaseAppData) {
                    window.appData.activeBowls = firebaseAppData.activeBowls || [];
                    window.appData.preparedBowls = firebaseAppData.preparedBowls || [];
                    window.appData.returnedBowls = firebaseAppData.returnedBowls || [];
                    window.appData.myScans = firebaseAppData.myScans || [];
                    window.appData.scanHistory = firebaseAppData.scanHistory || [];
                    window.appData.customerData = firebaseAppData.customerData || [];
                    
                    updateDisplay();
                    updateOvernightStats();
                    saveToStorage();
                    
                    console.log('‚úÖ Data loaded from Firebase');
                }
            });
        }

        async function syncToFirebase() {
            if (!database) {
                throw new Error('Firebase not available');
            }
            
            try {
                const backupData = {
                    activeBowls: [...window.appData.activeBowls],
                    preparedBowls: [...window.appData.preparedBowls],
                    returnedBowls: [...window.appData.returnedBowls],
                    myScans: [...window.appData.myScans],
                    scanHistory: [...window.appData.scanHistory],
                    customerData: [...window.appData.customerData],
                    lastSync: new Date().toISOString()
                };
                
                await set(ref(database, 'appData'), backupData);
                return true;
            } catch (error) {
                console.log('Firebase sync failed:', error);
                throw error;
            }
        }

        window.initializeFirebase = initializeFirebase;
        window.syncToFirebase = syncToFirebase;
    </script>

    <!-- Main Application Logic -->
    <script src="code.js"></script>
</body>
</html>
