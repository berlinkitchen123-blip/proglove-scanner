<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGlove Scanner - Reusable Bowl Tracking</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: #1a1a1a; color: white; padding: 10px; }
        .container { max-width: 100%; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .header { background: #4285f4; padding: 15px; text-align: center; border-radius: 10px; }
        .card { background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .sync-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .sync-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .download-btn { background: #4285f4; color: white; }
        .upload-btn { background: #34a853; color: white; }
        .export-btn { background: #f57c00; color: white; }
        .sync-btn:disabled { background: #666; cursor: not-allowed; }
        .system-status { padding: 10px; margin-top: 10px; border-radius: 5px; text-align: center; font-size: 12px; background: #444; border-left: 4px solid #f57c00; }
        .backup-status { background: #2a2a2a; padding: 8px; border-radius: 5px; margin-top: 5px; font-size: 11px; border-left: 4px solid #34a853; }
        .mode-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .kitchen-btn { background: #34a853; color: white; }
        .return-btn { background: #ea4335; color: white; }
        .mode-btn.active { box-shadow: 0 0 0 3px white; }
        .dropdown { width: 100%; padding: 12px; background: #444; color: white; border: 2px solid #666; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        .scan-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .scan-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .start-btn { background: #34a853; color: white; }
        .stop-btn { background: #ea4335; color: white; }
        .scan-btn:disabled { background: #666; cursor: not-allowed; }
        .proglove-input { width: 100%; padding: 15px; font-size: 18px; background: #333; color: white; border: 2px solid #666; border-radius: 8px; margin-bottom: 15px; text-align: center; }
        .proglove-input.error { border-color: #ea4335; animation: shake 0.5s; }
        .scanning-active { animation: pulse 1.5s infinite; border: 3px solid #34a853; }
        .feedback { padding: 12px; margin-top: 10px; border-radius: 6px; text-align: center; font-weight: bold; min-height: 50px; display: flex; align-items: center; justify-content: center; }
        .success { background: #34a853; }
        .error { background: #ea4335; }
        .warning { background: #f57c00; }
        .info { background: #4285f4; }
        .hidden { display: none; }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #333; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .kitchen-stat { color: #34a853; }
        .return-stat { color: #ea4335; }
        .active-stat { color: #4285f4; }
        .prep-stat { color: #f57c00; }
        .response-time { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
        .local-data { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #f57c00; }
        .upload-info { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #4285f4; }
        .cross-team-data { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #f57c00; }
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .data-label { font-weight: bold; }
        .admin-section { border: 2px solid #f57c00; }
        .json-textarea { width: 100%; height: 200px; background: #333; color: white; padding: 10px; border-radius: 5px; border: 1px solid #666; font-size: 12px; font-family: monospace; margin-bottom: 10px; }
        .results-info { background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px; border-left: 4px solid #34a853; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(52, 168, 83, 0); } 100% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß§ ProGlove Scanner - Reusable Bowl Tracking</h1>
            <p>Multi-Device ‚Ä¢ 5-Minute Backup ‚Ä¢ Reusable Bowl Management</p>
        </div>
        
        <div class="card">
            <h3>üìä SYSTEM STATUS</h3>
            <div class="system-status" id="systemStatus">
                üîÑ Connecting to cloud...
            </div>
            <div class="backup-status" id="backupStatus">
                ‚è≥ Next backup in: 5:00
            </div>
        </div>

        <div class="card">
            <h3>üì± SELECT MODE</h3>
            <div class="mode-buttons">
                <button class="mode-btn kitchen-btn" onclick="setMode('kitchen')" id="kitchenBtn">üç≥ KITCHEN</button>
                <button class="mode-btn return-btn" onclick="setMode('return')" id="returnBtn">üîÑ RETURN</button>
            </div>
        </div>
        
        <div class="card">
            <h3>üë§ SELECT USER</h3>
            <select class="dropdown" id="userDropdown" onchange="selectUser()">
                <option value="">-- Select User --</option>
            </select>
        </div>
        
        <div class="card hidden" id="dishSection">
            <h3>üìù SELECT DISH LETTER</h3>
            <select class="dropdown" id="dishDropdown" onchange="selectDishLetter()">
                <option value="">-- Select Dish Letter --</option>
            </select>
        </div>
        
        <div class="card hidden" id="crossTeamDataSection">
            <h3>üìä LIVE BOWL STATUS</h3>
            <div class="cross-team-data" id="crossTeamData">
                No active bowls yet
            </div>
        </div>
        
        <div class="card" id="scanSection">
            <h3>üîç SCANNING</h3>
            <div class="scan-controls">
                <button class="scan-btn start-btn" id="startBtn" onclick="startScanning()">‚ñ∂ START SCANNING</button>
                <button class="scan-btn stop-btn" id="stopBtn" onclick="stopScanning()" disabled>‚èπ STOP SCANNING</button>
            </div>
            
            <input type="text" class="proglove-input" id="progloveInput" placeholder="Click START SCANNING to begin..." disabled>
            
            <div class="response-time">
                Response time: <span id="responseTimeValue">0</span>ms
            </div>
            
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Active Bowls</div>
                    <div class="stat-value active-stat" id="activeCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label" id="prepLabel">Prepared Today</div>
                    <div class="stat-value prep-stat" id="prepCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">My Scans Today</div>
                    <div class="stat-value kitchen-stat" id="myScansCount">0</div>
                </div>
            </div>
            
            <div class="feedback info" id="feedback">
                ‚úÖ System ready - Select mode and user to start
            </div>
        </div>

        <!-- BACKUP SECTION (SIMPLIFIED) -->
        <div class="card admin-section">
            <h3>üõ°Ô∏è CLOUD BACKUP</h3>
            <div style="background: #444; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                <small>‚ÑπÔ∏è Auto-saves every 5 minutes ‚Ä¢ Parallel backup without interruption</small>
            </div>
            
            <div class="sync-controls">
                <button class="sync-btn download-btn" onclick="loadFromFirebase()" id="loadBackupBtn">
                    üì• LOAD FROM BACKUP
                </button>
            </div>
            <div class="local-data" id="backupInfo">
                <strong>Backup Status:</strong> Last backup: Never
            </div>
        </div>

        <!-- DATA INFO SECTION -->
        <div class="card">
            <h3>üíæ DATA INFO</h3>
            <div class="local-data" id="localDataInfo">
                <strong>Current Data:</strong> Loading...
            </div>
            <div class="upload-info" id="uploadInfo">
                <strong>Scan History:</strong> No scans yet
            </div>
        </div>

        <!-- JSON UPLOAD SECTION - AT THE BOTTOM -->
        <div class="card admin-section">
            <h3>üì§ UPLOAD BELLA BONA JSON DATA</h3>
            <div style="background: #444; padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                <small>‚ÑπÔ∏è Paste JSON to add historical data to Active sheet</small>
            </div>
            
            <textarea class="json-textarea" id="jsonInput" placeholder="Paste Bella Bona JSON data here..."></textarea>
            
            <div class="sync-controls">
                <button class="sync-btn upload-btn" onclick="processAndAddToActive()" id="processBtn">
                    üì• PROCESS & ADD TO ACTIVE
                </button>
                <button class="sync-btn export-btn" onclick="exportColorCodedExcel()" id="exportBtn">
                    üìä EXPORT COLOR-CODED EXCEL
                </button>
                <button class="sync-btn download-btn" onclick="exportScansToExcel()">
                    üìÑ EXPORT SCANS EXCEL
                </button>
            </div>
            
            <div class="results-info" id="processResults">
                Ready to process JSON data
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, get } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCL3hffCHosBceIRGR1it2dYEDb3uxIrJw",
            authDomain: "proglove-scanner.firebaseapp.com",
            databaseURL: "https://proglove-scanner-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "proglove-scanner",
            storageBucket: "proglove-scanner.firebasestorage.app",
            messagingSenderId: "177575768177",
            appId: "1:177575768177:web:0a0acbf222218e0c0b2bd0"
        };

        let app;
        let database;
        let lastBackupTime = null;

        function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                database = getDatabase(app);
                setupFirebaseListeners();
                loadLastBackupTime();
                
                setTimeout(() => {
                    if (typeof showMessage === 'function') {
                        showMessage('‚úÖ Cloud sync active ‚Ä¢ 5-min backup enabled', 'success');
                        document.getElementById('systemStatus').textContent = '‚úÖ Cloud sync active ‚Ä¢ 5-min backup enabled';
                    }
                }, 2000);
                
            } catch (error) {
                console.log('Firebase initialization failed:', error);
                if (typeof showMessage === 'function') {
                    showMessage('‚ö†Ô∏è Offline mode - scanning works locally', 'warning');
                    document.getElementById('systemStatus').textContent = '‚ö†Ô∏è Offline mode - Scanning works locally';
                }
            }
        }

        function setupFirebaseListeners() {
            if (!database) return;

            const appDataRef = ref(database, 'appData');
            onValue(appDataRef, (snapshot) => {
                const firebaseAppData = snapshot.val();
                if (firebaseAppData && window.appData) {
                    window.appData.activeBowls = firebaseAppData.activeBowls || [];
                    window.appData.preparedBowls = firebaseAppData.preparedBowls || [];
                    window.appData.returnedBowls = firebaseAppData.returnedBowls || [];
                    window.appData.myScans = firebaseAppData.myScans || [];
                    window.appData.scanHistory = firebaseAppData.scanHistory || [];
                    
                    if (typeof updateDisplay === 'function') updateDisplay();
                    if (typeof saveToStorage === 'function') saveToStorage();
                }
            });

            const backupTimeRef = ref(database, 'lastBackupTime');
            onValue(backupTimeRef, (snapshot) => {
                lastBackupTime = snapshot.val();
                updateBackupDisplay();
            });
        }

        function syncToFirebase() {
            if (!database) return;
            try {
                set(ref(database, 'appData'), {
                    activeBowls: window.appData?.activeBowls || [],
                    preparedBowls: window.appData?.preparedBowls || [],
                    returnedBowls: window.appData?.returnedBowls || [],
                    myScans: window.appData?.myScans || [],
                    scanHistory: window.appData?.scanHistory || [],
                    lastSync: new Date().toISOString()
                });
                
                const backupTime = new Date().toISOString();
                set(ref(database, 'lastBackupTime'), backupTime);
                lastBackupTime = backupTime;
                updateBackupDisplay();
                
                console.log('‚úÖ Auto-backup completed');
                
            } catch (error) {
                console.log('Firebase sync failed:', error);
            }
        }

        async function loadFromFirebase() {
            if (!database) return;
            
            try {
                const appDataRef = ref(database, 'appData');
                const snapshot = await get(appDataRef);
                const data = snapshot.val();
                
                if (data) {
                    window.appData.activeBowls = data.activeBowls || [];
                    window.appData.preparedBowls = data.preparedBowls || [];
                    window.appData.returnedBowls = data.returnedBowls || [];
                    window.appData.myScans = data.myScans || [];
                    window.appData.scanHistory = data.scanHistory || [];
                    
                    if (typeof updateDisplay === 'function') updateDisplay();
                    if (typeof saveToStorage === 'function') saveToStorage();
                    
                    showMessage('‚úÖ Data loaded from Firebase backup', 'success');
                } else {
                    showMessage('‚ÑπÔ∏è No data found in Firebase', 'info');
                }
            } catch (error) {
                showMessage('‚ùå Error loading from Firebase', 'error');
            }
        }

        function loadLastBackupTime() {
            if (!database) return;
            
            const backupTimeRef = ref(database, 'lastBackupTime');
            onValue(backupTimeRef, (snapshot) => {
                lastBackupTime = snapshot.val();
                updateBackupDisplay();
            });
        }

        function updateBackupDisplay() {
            const backupInfo = document.getElementById('backupInfo');
            
            if (lastBackupTime) {
                const backupDate = new Date(lastBackupTime);
                backupInfo.innerHTML = `<strong>Backup Status:</strong> Last backup: ${backupDate.toLocaleTimeString()}`;
            } else {
                backupInfo.innerHTML = '<strong>Backup Status:</strong> Last backup: Never';
            }
            
            updateBackupCountdown();
        }

        function updateBackupCountdown() {
            const backupStatus = document.getElementById('backupStatus');
            if (!window.nextBackupTime) return;
            
            const now = new Date();
            const timeLeft = Math.max(0, window.nextBackupTime - now);
            const minutes = Math.floor(timeLeft / 60000);
            const seconds = Math.floor((timeLeft % 60000) / 1000);
            
            backupStatus.textContent = `‚è≥ Next backup in: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        window.initializeFirebase = initializeFirebase;
        window.syncToFirebase = syncToFirebase;
        window.loadFromFirebase = loadFromFirebase;
        window.updateBackupDisplay = updateBackupDisplay;
    </script>

    <!-- Main Application Logic -->
    <script>
        // ProGlove Scanner - REUSABLE BOWL TRACKING SYSTEM
        window.appData = {
            mode: null,
            user: null,
            dishLetter: null,
            scanning: false,
            myScans: [],
            activeBowls: [],
            preparedBowls: [],
            returnedBowls: [],
            scanHistory: [],
            lastActivity: Date.now(),
            autoSaveTimer: null,
            emergencyBackupTimer: null,
            lastCleanup: null
        };

        const USERS = [
            {name: "Hamid", role: "Kitchen"},
            {name: "Richa", role: "Kitchen"},
            {name: "Mary", role: "Kitchen"},
            {name: "Jash", role: "Kitchen"},
            {name: "Joel", role: "Kitchen"},
            {name: "Rushal", role: "Kitchen"},
            {name: "Sreekanth", role: "Kitchen"},
            {name: "M.Sultan", role: "Return"},
            {name: "Riyaz", role: "Return"},
            {name: "Alan", role: "Return"},
            {name: "Aadesh", role: "Return"},
            {name: "Kitchen Team", role: "Return"}
        ];

        // JSON Processing Variables
        window.jsonData = null;
        window.multiOrderMap = {};

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing Reusable Bowl Tracking System...');
            initializeFirebase();
            loadFromStorage();
            initializeUsers();
            updateDisplay();
            startAutoSaveTimer();
            startEmergencyBackupTimer();
            startDailyCleanupTimer();
            startBackupCountdownTimer();
            
            document.getElementById('progloveInput').addEventListener('input', handleScanInput);
            document.addEventListener('click', updateLastActivity);
            document.addEventListener('keydown', updateLastActivity);
        });

        function updateLastActivity() {
            window.appData.lastActivity = Date.now();
        }

        function startAutoSaveTimer() {
            if (window.appData.autoSaveTimer) {
                clearInterval(window.appData.autoSaveTimer);
            }
            
            window.appData.autoSaveTimer = setInterval(() => {
                saveToStorage();
            }, 30000);
        }

        function startEmergencyBackupTimer() {
            if (window.appData.emergencyBackupTimer) {
                clearInterval(window.appData.emergencyBackupTimer);
            }
            
            window.appData.emergencyBackupTimer = setInterval(() => {
                console.log('üîÑ AUTO BACKUP: Saving to Firebase...');
                syncToFirebase();
            }, 300000); // 5 minutes
            
            window.nextBackupTime = new Date(Date.now() + 300000);
        }

        function startBackupCountdownTimer() {
            setInterval(() => {
                updateBackupCountdown();
            }, 1000);
        }

        function startDailyCleanupTimer() {
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 19 && now.getMinutes() === 0) {
                    cleanupReturnedBowls();
                }
            }, 60000);
        }

        function cleanupReturnedBowls() {
            const today = new Date().toLocaleDateString('en-GB');
            if (window.appData.lastCleanup === today) return;
            
            window.appData.returnedBowls = [];
            window.appData.lastCleanup = today;
            saveToStorage();
            syncToFirebase();
            showMessage('‚úÖ Daily cleanup completed - returned bowls cleared', 'success');
        }

        // Storage functions
        function saveToStorage() {
            try {
                localStorage.setItem('proglove_data', JSON.stringify(window.appData));
            } catch (error) {
                console.log('Storage save note:', error.message);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('proglove_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    window.appData = { ...window.appData, ...data };
                    console.log('Data loaded from storage');
                }
            } catch (error) {
                console.log('No previous data found - starting fresh');
            }
        }

        // JSON PROCESSING FUNCTIONS
        function processAndAddToActive() {
            const jsonText = document.getElementById('jsonInput').value.trim();
            if (!jsonText) {
                showMessage('‚ùå Please paste JSON data first', 'error');
                return;
            }

            try {
                const jsonData = JSON.parse(jsonText);
                window.jsonData = jsonData;
                
                const results = processJSONData(jsonData);
                updateProcessResults(results);
                showMessage(`‚úÖ Processed ${results.totalBowls} bowls ‚Ä¢ ${results.addedToActive} added to Active`, 'success');
                
            } catch (error) {
                showMessage('‚ùå Invalid JSON format: ' + error.message, 'error');
            }
        }

        function processJSONData(jsonData) {
            let totalBowls = 0;
            let addedToActive = 0;
            let enrichedBowls = 0;
            
            // Build multi-order map for color coding
            buildMultiOrderMap(jsonData);
            
            jsonData.forEach(company => {
                company.boxes.forEach(box => {
                    box.dishes.forEach(dish => {
                        dish.bowlCodes.forEach((vytCode, index) => {
                            totalBowls++;
                            
                            // Try to find in Active
                            const activeBowl = window.appData.activeBowls.find(
                                bowl => bowl.code === vytCode
                            );
                            
                            if (activeBowl) {
                                // Enrich existing bowl
                                activeBowl.company = company.name;
                                activeBowl.customer = dish.users[index]?.username || 'Unknown';
                                activeBowl.dish = dish.label;
                                activeBowl.dishName = dish.name;
                                enrichedBowls++;
                            } else {
                                // CREATE NEW BOWL IN ACTIVE
                                const newBowl = {
                                    code: vytCode,
                                    dish: dish.label,
                                    user: 'Historical Data',
                                    company: company.name,
                                    customer: dish.users[index]?.username || 'Unknown',
                                    date: extractDateFromJSON(jsonData),
                                    time: '12:00',
                                    timestamp: new Date().toISOString(),
                                    status: 'ACTIVE',
                                    historical: true,
                                    dishName: dish.name
                                };
                                window.appData.activeBowls.push(newBowl);
                                addedToActive++;
                            }
                        });
                    });
                });
            });
            
            saveToStorage();
            syncToFirebase();
            updateDisplay();
            
            return {
                totalBowls: totalBowls,
                addedToActive: addedToActive,
                enrichedBowls: enrichedBowls
            };
        }

        function buildMultiOrderMap(jsonData) {
            window.multiOrderMap = {};
            
            jsonData.forEach(company => {
                if (!window.multiOrderMap[company.name]) {
                    window.multiOrderMap[company.name] = {};
                }
                
                company.boxes.forEach(box => {
                    box.dishes.forEach(dish => {
                        const dishLetter = dish.label;
                        if (!window.multiOrderMap[company.name][dishLetter]) {
                            window.multiOrderMap[company.name][dishLetter] = [];
                        }
                        
                        // Add all customers for this dish letter
                        dish.users.forEach(user => {
                            if (user.username && !window.multiOrderMap[company.name][dishLetter].includes(user.username)) {
                                window.multiOrderMap[company.name][dishLetter].push(user.username);
                            }
                        });
                    });
                });
            });
        }

        function extractDateFromJSON(jsonData) {
            // Try to extract date from uniqueIdentifier
            if (jsonData[0]?.boxes[0]?.uniqueIdentifier) {
                const dateMatch = jsonData[0].boxes[0].uniqueIdentifier.match(/\d{4}-\d{2}-\d{2}/);
                if (dateMatch) return dateMatch[0];
            }
            return new Date().toISOString().split('T')[0];
        }

        function updateProcessResults(results) {
            const resultsElement = document.getElementById('processResults');
            resultsElement.innerHTML = `
                <strong>üìä Processing Results:</strong><br>
                <div class="data-row"><span>Total Bowls in JSON:</span><span>${results.totalBowls}</span></div>
                <div class="data-row"><span>Added to Active Sheet:</span><span>${results.addedToActive}</span></div>
                <div class="data-row"><span>Enriched Existing Bowls:</span><span>${results.enrichedBowls}</span></div>
                <div class="data-row"><span>Current Active Bowls:</span><span>${window.appData.activeBowls.length}</span></div>
            `;
        }

        // EXCEL EXPORT FUNCTIONS
        function exportColorCodedExcel() {
            if (!window.jsonData) {
                showMessage('‚ùå Please process JSON data first', 'error');
                return;
            }

            // Create worksheet data
            const worksheetData = [
                ['VYT Code', 'Company', 'Customer', 'Dish Letter', 'Dish Name', 'Order Type']
            ];
            
            window.jsonData.forEach(company => {
                company.boxes.forEach(box => {
                    box.dishes.forEach(dish => {
                        dish.bowlCodes.forEach((vytCode, index) => {
                            const customer = dish.users[index]?.username || 'Unknown';
                            
                            // Check if multiple customers for this dish letter
                            const isMultiple = window.multiOrderMap[company.name]?.[dish.label]?.length > 1;
                            const orderType = isMultiple ? 'MULTIPLE' : 'SINGLE';
                            
                            worksheetData.push([
                                vytCode || 'NO_CODE',
                                company.name,
                                customer,
                                dish.label,
                                dish.name,
                                orderType
                            ]);
                        });
                    });
                });
            });
            
            downloadExcel(worksheetData, `bowl_tracking_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage('‚úÖ Color-coded Excel exported!', 'success');
        }

        function exportScansToExcel() {
            if (window.appData.myScans.length === 0) {
                showMessage("‚ÑπÔ∏è No scans to export", "info");
                return;
            }
            
            const worksheetData = [
                ['Type', 'VYT Code', 'Dish Letter', 'User', 'Date', 'Time', 'Company', 'Customer', 'Timestamp']
            ];
            
            window.appData.myScans.forEach(scan => {
                worksheetData.push([
                    scan.type,
                    scan.code,
                    scan.dish || '',
                    scan.user,
                    new Date(scan.timestamp).toLocaleDateString('en-GB'),
                    new Date(scan.timestamp).toLocaleTimeString(),
                    scan.company,
                    scan.customer,
                    scan.timestamp
                ]);
            });
            
            downloadExcel(worksheetData, `scans_${new Date().toISOString().split('T')[0]}.xlsx`);
            showMessage("‚úÖ Scans exported to Excel!", "success");
        }

        function downloadExcel(data, filename) {
            // Create workbook and worksheet
            const workbook = XLSX.utils.book_new();
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            
            // Add worksheet to workbook
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Bowl Data');
            
            // Generate Excel file and download
            XLSX.writeFile(workbook, filename);
        }

        // USER AND MODE MANAGEMENT
        function initializeUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            USERS.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name + (user.role ? ` (${user.role})` : '');
                dropdown.appendChild(option);
            });
        }

        function setMode(mode) {
            window.appData.mode = mode;
            window.appData.user = null;
            window.appData.dishLetter = null;
            window.appData.scanning = false;
            
            document.getElementById('kitchenBtn').classList.toggle('active', mode === 'kitchen');
            document.getElementById('returnBtn').classList.toggle('active', mode === 'return');
            
            document.getElementById('dishSection').classList.toggle('hidden', mode !== 'kitchen');
            document.getElementById('crossTeamDataSection').classList.remove('hidden');
            document.getElementById('userDropdown').value = '';
            document.getElementById('dishDropdown').value = '';
            document.getElementById('progloveInput').value = '';
            
            loadUsers();
            updateStatsLabels();
            updateDisplay();
            updateLastActivity();
            showMessage(`üì± ${mode.toUpperCase()} mode selected`, 'info');
        }

        function updateStatsLabels() {
            const prepLabel = document.getElementById('prepLabel');
            if (window.appData.mode === 'kitchen') {
                prepLabel.textContent = 'Prepared Today';
            } else {
                prepLabel.textContent = 'Returned Today';
            }
        }

        function loadUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            let usersToShow = [];
            if (window.appData.mode === 'kitchen') {
                usersToShow = USERS.filter(user => user.role === 'Kitchen');
            } else if (window.appData.mode === 'return') {
                usersToShow = USERS.filter(user => user.role === 'Return' || user.name === "Kitchen Team");
            }
            
            usersToShow.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name + (user.role ? ` (${user.role})` : '');
                dropdown.appendChild(option);
            });
        }

        function selectUser() {
            const dropdown = document.getElementById('userDropdown');
            window.appData.user = dropdown.value;
            
            if (window.appData.user) {
                showMessage(`‚úÖ ${window.appData.user} selected`, 'success');
                if (window.appData.mode === 'kitchen') {
                    document.getElementById('dishSection').classList.remove('hidden');
                    loadDishLetters();
                }
            }
            updateDisplay();
            updateLastActivity();
        }

        function loadDishLetters() {
            const dropdown = document.getElementById('dishDropdown');
            dropdown.innerHTML = '<option value="">-- Select Dish Letter --</option>';
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = letter;
                dropdown.appendChild(option);
            });
        }

        function selectDishLetter() {
            const dropdown = document.getElementById('dishDropdown');
            window.appData.dishLetter = dropdown.value;
            
            if (window.appData.dishLetter) {
                showMessage(`üìù Dish ${window.appData.dishLetter} selected`, 'success');
            }
            updateDisplay();
            updateLastActivity();
        }

        // SCANNING FUNCTIONS
        function startScanning() {
            if (!window.appData.user) {
                showMessage('‚ùå Please select user first', 'error');
                return;
            }
            if (window.appData.mode === 'kitchen' && !window.appData.dishLetter) {
                showMessage('‚ùå Please select dish letter first', 'error');
                return;
            }
            
            window.appData.scanning = true;
            updateDisplay();
            document.getElementById('progloveInput').focus();
            updateLastActivity();
            showMessage(`üéØ SCANNING ACTIVE - Ready to scan`, 'success');
        }

        function stopScanning() {
            window.appData.scanning = false;
            updateDisplay();
            updateLastActivity();
            showMessage(`‚èπ Scanning stopped`, 'info');
        }

        function handleScanInput(e) {
            if (!window.appData.scanning) return;
            
            const scanValue = e.target.value.trim();
            if (scanValue.length >= 2) {
                processScan(scanValue);
                setTimeout(() => e.target.value = '', 100);
            }
            updateLastActivity();
        }

        function processScan(code) {
            let result;
            
            if (window.appData.mode === 'kitchen') {
                result = kitchenScan(code);
            } else {
                result = returnScan(code);
            }
            
            document.getElementById('responseTimeValue').textContent = result.responseTime;
            showMessage(result.message, result.type);
            
            if (result.type === 'error') {
                document.getElementById('progloveInput').classList.add('error');
                setTimeout(() => document.getElementById('progloveInput').classList.remove('error'), 2000);
            }
            
            updateDisplay();
            updateLastActivity();
        }

        function kitchenScan(code) {
            const startTime = Date.now();
            const fullCode = code.toUpperCase();
            const today = new Date().toLocaleDateString('en-GB');
            
            if (window.appData.activeBowls.some(bowl => bowl.code === fullCode)) {
                return { 
                    message: "‚ùå Bowl already active: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            if (window.appData.preparedBowls.some(bowl => bowl.code === fullCode && bowl.date === today)) {
                return { 
                    message: "‚ùå Already prepared today: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            const newBowl = {
                code: fullCode,
                dish: window.appData.dishLetter,
                user: window.appData.user,
                company: "Unknown",
                customer: "Unknown",
                date: today,
                time: new Date().toLocaleTimeString(),
                timestamp: new Date().toISOString(),
                status: 'ACTIVE'
            };
            
            window.appData.activeBowls.push(newBowl);
            window.appData.preparedBowls.push({...newBowl, status: 'PREPARED'});
            
            window.appData.myScans.push({
                type: 'kitchen',
                code: fullCode,
                dish: window.appData.dishLetter,
                user: window.appData.user,
                company: "Unknown",
                customer: "Unknown",
                timestamp: new Date().toISOString()
            });
            
            window.appData.scanHistory.unshift({
                type: 'kitchen',
                code: fullCode,
                user: window.appData.user,
                timestamp: new Date().toISOString(),
                message: `${window.appData.dishLetter} Prepared: ${fullCode}`
            });
            
            saveToStorage();
            syncToFirebase();
            return { 
                message: `‚úÖ ${window.appData.dishLetter} Prepared: ${fullCode} - Now ACTIVE for returns`, 
                type: "success",
                responseTime: Date.now() - startTime
            };
        }

        function returnScan(code) {
            const startTime = Date.now();
            const fullCode = code.toUpperCase();
            const today = new Date().toLocaleDateString('en-GB');
            
            const activeBowlIndex = window.appData.activeBowls.findIndex(bowl => bowl.code === fullCode);
            
            if (activeBowlIndex === -1) {
                if (window.appData.returnedBowls.some(bowl => bowl.code === fullCode)) {
                    return { 
                        message: "‚ùå Already returned: " + fullCode, 
                        type: "error",
                        responseTime: Date.now() - startTime
                    };
                } else {
                    return { 
                        message: "‚ùå Bowl not found in active bowls: " + fullCode, 
                        type: "error",
                        responseTime: Date.now() - startTime
                    };
                }
            }
            
            const activeBowl = window.appData.activeBowls[activeBowlIndex];
            
            // Remove from active bowls
            window.appData.activeBowls.splice(activeBowlIndex, 1);
            
            window.appData.returnedBowls.push({
                ...activeBowl,
                returnedBy: window.appData.user,
                returnDate: today,
                returnTime: new Date().toLocaleTimeString(),
                returnTimestamp: new Date().toISOString(),
                status: 'RETURNED'
            });
            
            window.appData.myScans.push({
                type: 'return',
                code: fullCode,
                user: window.appData.user,
                company: activeBowl.company,
                customer: activeBowl.customer,
                timestamp: new Date().toISOString(),
                originalData: activeBowl
            });
            
            window.appData.scanHistory.unshift({
                type: 'return',
                code: fullCode,
                user: window.appData.user,
                timestamp: new Date().toISOString(),
                message: `Returned: ${fullCode} (${activeBowl.company} - ${activeBowl.customer})`
            });
            
            saveToStorage();
            syncToFirebase();
            return { 
                message: `‚úÖ Returned: ${fullCode} - ${activeBowl.company} - ${activeBowl.customer}`, 
                type: "success",
                responseTime: Date.now() - startTime
            };
        }

        function updateDisplay() {
            document.getElementById('userDropdown').disabled = false;
            document.getElementById('dishDropdown').disabled = false;
            
            let canScan = window.appData.user && !window.appData.scanning;
            if (window.appData.mode === 'kitchen') canScan = canScan && window.appData.dishLetter;
            document.getElementById('startBtn').disabled = !canScan;
            document.getElementById('stopBtn').disabled = !window.appData.scanning;
            
            const input = document.getElementById('progloveInput');
            if (window.appData.scanning) {
                document.getElementById('scanSection').classList.add('scanning-active');
                input.placeholder = "Scan VYT code...";
                input.disabled = false;
            } else {
                document.getElementById('scanSection').classList.remove('scanning-active');
                input.placeholder = "Click START SCANNING...";
                input.disabled = !window.appData.scanning;
            }
            
            const today = new Date().toLocaleDateString('en-GB');
            const userTodayScans = window.appData.myScans.filter(scan => 
                scan.user === window.appData.user && 
                new Date(scan.timestamp).toLocaleDateString('en-GB') === today
            ).length;
            
            const preparedToday = window.appData.preparedBowls.filter(bowl => bowl.date === today).length;
            const returnedToday = window.appData.returnedBowls.filter(bowl => bowl.returnDate === today).length;
            
            document.getElementById('activeCount').textContent = window.appData.activeBowls.length;
            
            if (window.appData.mode === 'kitchen') {
                document.getElementById('prepCount').textContent = preparedToday;
                document.getElementById('myScansCount').textContent = userTodayScans;
            } else {
                document.getElementById('prepCount').textContent = returnedToday;
                document.getElementById('myScansCount').textContent = userTodayScans;
            }
            
            document.getElementById('localDataInfo').innerHTML = `
                <strong>Current Data:</strong> 
                ${window.appData.activeBowls.length} active bowls ‚Ä¢ 
                ${preparedToday} prepared today ‚Ä¢ 
                ${returnedToday} returned today ‚Ä¢
                ${window.appData.myScans.length} total scans
            `;
            
            const uploadInfo = document.getElementById('uploadInfo');
            if (window.appData.scanHistory.length === 0) {
                uploadInfo.innerHTML = '<strong>Scan History:</strong> No scans yet';
            } else {
                let html = '<strong>Recent Scans:</strong><br>';
                window.appData.scanHistory.slice(0, 5).forEach(record => {
                    const date = new Date(record.timestamp);
                    html += `<div class="data-row">
                        <span class="data-label">${record.type === 'kitchen' ? 'üç≥' : 'üîÑ'} ${record.user}</span>
                        <span>${date.toLocaleTimeString()}</span>
                        <span>${record.code}</span>
                    </div>`;
                });
                uploadInfo.innerHTML = html;
            }
            
            updateCrossTeamData();
        }

        function updateCrossTeamData() {
            const element = document.getElementById('crossTeamData');
            const today = new Date().toLocaleDateString('en-GB');
            
            const preparedToday = window.appData.preparedBowls.filter(bowl => bowl.date === today).length;
            const returnedToday = window.appData.returnedBowls.filter(bowl => bowl.returnDate === today).length;
            
            if (window.appData.mode === 'kitchen') {
                element.innerHTML = `
                    <div class="data-row"><span class="data-label">Today's Returns:</span><span>${returnedToday} bowls</span></div>
                    <div class="data-row"><span class="data-label">Active Bowls:</span><span>${window.appData.activeBowls.length} bowls</span></div>
                    <div class="data-row"><span class="data-label">My Preparations:</span><span>${window.appData.myScans.filter(s => s.type === 'kitchen' && s.user === window.appData.user).length} bowls</span></div>
                `;
            } else {
                element.innerHTML = `
                    <div class="data-row"><span class="data-label">Today's Preparations:</span><span>${preparedToday} bowls</span></div>
                    <div class="data-row"><span class="data-label">Active Bowls:</span><span>${window.appData.activeBowls.length} bowls</span></div>
                    <div class="data-row"><span class="data-label">My Returns:</span><span>${window.appData.myScans.filter(s => s.type === 'return' && s.user === window.appData.user).length} bowls</span></div>
                `;
            }
        }

        function showMessage(text, type) {
            const element = document.getElementById('feedback');
            element.textContent = text;
            element.className = 'feedback ' + type;
        }
    </script>
</body>
</html>
