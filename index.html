<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGlove Scanner System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }
        
        body {
            background-color: #f0f2f5;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        h1 {
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .mode-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn.active {
            background: #2980b9;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        select, input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .feedback {
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .scanning-active {
            border: 2px solid #27ae60;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { border-color: #27ae60; }
            50% { border-color: #2ecc71; }
            100% { border-color: #27ae60; }
        }
        
        .export-section {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f8f9fa;
        }
        
        .red-text {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .green-text {
            color: #27ae60;
            font-weight: bold;
        }
        
        .dish-header {
            font-weight: bold;
            background: #ecf0f1;
        }
        
        .json-section {
            background: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin-top: 15px;
        }
        
        textarea {
            width: 100%;
            min-height: 120px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .patch-results {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
        }
        
        .time-stats {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ProGlove Scanner System</h1>
            <p>Complete bowl tracking solution</p>
        </header>
        
        <div class="card">
            <h2>Operation Mode</h2>
            <div class="mode-selector">
                <button id="kitchenBtn" class="btn btn-primary" onclick="setMode('kitchen')">Kitchen Mode</button>
                <button id="returnBtn" class="btn btn-primary" onclick="setMode('return')">Return Mode</button>
            </div>
            
            <div class="form-group">
                <label for="userDropdown">Select User:</label>
                <select id="userDropdown" onchange="selectUser()">
                    <option value="">-- Select User --</option>
                </select>
            </div>
            
            <div id="dishSection" class="form-group hidden">
                <label for="dishDropdown">Select Dish Letter:</label>
                <select id="dishDropdown" onchange="selectDishLetter()">
                    <option value="">-- Select Dish Letter --</option>
                </select>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <div>Active Bowls</div>
                <div id="activeCount" class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div id="prepLabel">Prepared Today</div>
                <div id="prepCount" class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div>My Scans Today</div>
                <div id="myScansCount" class="stat-value">0</div>
            </div>
            <div class="stat-card">
                <div>Response Time</div>
                <div id="responseTimeValue" class="stat-value">0ms</div>
            </div>
        </div>

        <div class="card">
            <h2>Dish Preparation Times</h2>
            <div id="dishTimesList">
                <p>No dish preparation data</p>
            </div>
        </div>
        
        <div id="feedback" class="feedback info">
            Welcome! Please select a mode to begin.
        </div>
        
        <div class="card">
            <h2>Scanning Control</h2>
            <div id="scanSection" class="form-group">
                <label for="progloveInput">Scan VYT Code:</label>
                <input type="text" id="progloveInput" placeholder="Click START SCANNING...">
                <div style="display: flex; gap: 10px; margin-top: 15px;">
                    <button id="startBtn" class="btn btn-success" onclick="startScanning()">START SCANNING</button>
                    <button id="stopBtn" class="btn btn-danger" onclick="stopScanning()" disabled>STOP SCANNING</button>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Overnight Statistics</h2>
            <div id="cycleInfo">Current Cycle: Tonight 10PM - Tomorrow 10AM</div>
            <table>
                <thead>
                    <tr>
                        <th>Dish</th>
                        <th>User</th>
                        <th>Count</th>
                        <th>Start Time</th>
                        <th>End Time</th>
                    </tr>
                </thead>
                <tbody id="overnightStatsBody">
                    <tr>
                        <td colspan="5" style="text-align: center;">No scans in current overnight cycle</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="card">
            <h2>Active Bowls</h2>
            <div id="activeBowlsList">
                <p>No active bowls</p>
            </div>
        </div>
        
        <div class="card">
            <h2>JSON Data Patch</h2>
            <div class="json-section">
                <p>Paste JSON data to update bowl information:</p>
                <textarea id="jsonData" placeholder='Paste JSON data here...'></textarea>
                <button class="btn btn-warning" onclick="processJSONData()" style="margin-top: 10px;">Process JSON Data</button>
                
                <div id="patchResults" class="patch-results" style="display: none;">
                    <div id="patchSummary" style="font-weight: bold; margin-bottom: 10px;"></div>
                    <div id="failedMatches"></div>
                </div>
                
                <div id="jsonStatus" style="margin-top: 10px;"></div>
            </div>
        </div>
        
        <div class="card">
            <h2>Data Export</h2>
            <p id="exportInfo">Data Status: No data available</p>
            <div class="export-section">
                <button class="btn btn-primary" onclick="exportActiveBowls()">Export Active Bowls</button>
                <button class="btn btn-primary" onclick="exportReturnData()">Export Return Data</button>
                <button class="btn btn-success" onclick="exportAllData()">Export All Data</button>
                <button class="btn btn-warning" onclick="clearStuckBowls()">Clear Stuck Bowls</button>
            </div>
        </div>
    </div>

    <script>
        // ProGlove Scanner - Complete System
        window.appData = {
            mode: null,
            user: null,
            dishLetter: null,
            scanning: false,
            myScans: [],
            activeBowls: [],
            preparedBowls: [],
            returnedBowls: [],
            scanHistory: [],
            customerData: [],
            dishTimes: {}, // Track dish preparation times
            lastActivity: Date.now(),
            lastCleanup: null
        };

        // CORRECTED USER LIST
        const USERS = [
            {name: "Hamid", role: "Kitchen"},
            {name: "Richa", role: "Kitchen"},
            {name: "Jash", role: "Kitchen"},
            {name: "Joes", role: "Kitchen"},
            {name: "Mary", role: "Kitchen"},
            {name: "Rushal", role: "Kitchen"},
            {name: "Sreekanth", role: "Kitchen"},
            {name: "Sultan", role: "Return"},
            {name: "Riyaz", role: "Return"},
            {name: "Alan", role: "Return"},
            {name: "Adesh", role: "Return"}
        ];

        // STANDARDIZED DATE FUNCTION
        function getStandardizedDate(dateString = null) {
            const date = dateString ? new Date(dateString) : new Date();
            return date.toISOString().split('T')[0];
        }

        // Initialize System
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Initializing Scanner System...');
            loadFromStorage();
            initializeUsers();
            updateDisplay();
            updateOvernightStats();
            startDailyCleanupTimer();
            
            document.getElementById('progloveInput').addEventListener('input', handleScanInput);
            document.addEventListener('click', updateLastActivity);
            document.addEventListener('keydown', updateLastActivity);
        });

        function updateLastActivity() {
            window.appData.lastActivity = Date.now();
        }

        // FIXED SCAN INPUT HANDLER
        function handleScanInput(e) {
            if (!window.appData.scanning) return;
            
            const scanValue = e.target.value.trim();
            if (scanValue.length >= 6) {
                console.log('Processing scan:', scanValue);
                processScan(scanValue);
                
                // Clear input properly after processing
                setTimeout(() => {
                    e.target.value = '';
                }, 100);
            }
            updateLastActivity();
        }

        // UPDATED JSON Data Processing - Removes from prepared bowls only
        function processJSONData() {
            const jsonTextarea = document.getElementById('jsonData');
            const jsonText = jsonTextarea.value.trim();
            
            if (!jsonText) {
                showMessage('❌ Please paste JSON data first', 'error');
                return;
            }
            
            try {
                const jsonData = JSON.parse(jsonText);
                
                console.log('🔍 Starting JSON patch process...');
                
                const patchResults = {
                    matched: 0,
                    failed: [],
                    removedFromPrepared: 0
                };

                // STEP 1: Extract all bowl codes from JSON
                const extractedData = [];
                
                const deliveries = Array.isArray(jsonData) ? jsonData : [jsonData];
                
                deliveries.forEach((delivery, deliveryIndex) => {
                    console.log(`Processing delivery ${deliveryIndex + 1}: ${delivery.name || 'Unnamed'}`);
                    
                    if (delivery.boxes && Array.isArray(delivery.boxes)) {
                        delivery.boxes.forEach((box, boxIndex) => {
                            console.log(`  Processing box ${boxIndex + 1}: ${box.uniqueIdentifier || 'No ID'}`);
                            
                            if (box.dishes && Array.isArray(box.dishes)) {
                                box.dishes.forEach((dish, dishIndex) => {
                                    console.log(`    Processing dish ${dishIndex + 1}: ${dish.name || 'No name'} (Label: ${dish.label || 'No label'})`);
                                    
                                    if (dish.bowlCodes && Array.isArray(dish.bowlCodes) && dish.bowlCodes.length > 0) {
                                        dish.bowlCodes.forEach((bowlCode, codeIndex) => {
                                            // Use ORIGINAL code exactly as in JSON
                                            const originalCode = bowlCode;
                                            
                                            // Get customer name from dish users
                                            let customerName = "Unknown";
                                            if (dish.users && dish.users.length > 0) {
                                                customerName = dish.users.map(user => user.username).join(', ');
                                            }
                                            
                                            extractedData.push({
                                                code: originalCode,
                                                company: delivery.name || "Unknown Company",
                                                customer: customerName,
                                                dish: dish.label || "Unknown",
                                                delivery: delivery.name,
                                                box: box.uniqueIdentifier
                                            });
                                            
                                            console.log(`      ✅ Extracted: ${originalCode} for ${customerName}`);
                                        });
                                    }
                                });
                            }
                        });
                    }
                });

                // STEP 2: Process each extracted code
                extractedData.forEach((item, index) => {
                    const originalCode = item.code;
                    
                    // Find in active bowls and update
                    const activeMatches = window.appData.activeBowls.filter(bowl => bowl.code === originalCode);
                    
                    if (activeMatches.length > 0) {
                        activeMatches.forEach(bowl => {
                            bowl.company = item.company;
                            bowl.customer = item.customer;
                            bowl.dish = item.dish || bowl.dish;
                        });
                        patchResults.matched += activeMatches.length;
                    }
                    
                    // Find in prepared bowls and REMOVE (as requested)
                    const preparedIndex = window.appData.preparedBowls.findIndex(bowl => bowl.code === originalCode);
                    if (preparedIndex !== -1) {
                        window.appData.preparedBowls.splice(preparedIndex, 1);
                        patchResults.removedFromPrepared++;
                        console.log(`🗑️ Removed from prepared: ${originalCode}`);
                    }
                    
                    if (activeMatches.length === 0 && preparedIndex === -1) {
                        patchResults.failed.push({
                            code: originalCode,
                            reason: 'Not found in active or prepared bowls'
                        });
                    }
                });

                // Update display and save
                updateDisplay();
                saveToStorage();
                
                // Show results
                const resultMessage = `✅ JSON assignment completed:\n` +
                                     `• Total codes found: ${extractedData.length}\n` +
                                     `• Active bowls updated: ${patchResults.matched}\n` +
                                     `• Removed from prepared: ${patchResults.removedFromPrepared}\n` +
                                     `• Failed: ${patchResults.failed.length}`;
                
                showMessage(resultMessage, 'success');
                
                // Show detailed results
                document.getElementById('patchResults').style.display = 'block';
                document.getElementById('patchSummary').textContent = 
                    `Found: ${extractedData.length} codes | Active Updated: ${patchResults.matched} | Removed from Prepared: ${patchResults.removedFromPrepared} | Failed: ${patchResults.failed.length}`;
                
                const failedDiv = document.getElementById('failedMatches');
                if (patchResults.failed.length > 0) {
                    let failedHtml = '<strong>Failed assignments:</strong><br>';
                    patchResults.failed.forEach(failed => {
                        failedHtml += `• ${failed.code} (${failed.reason})<br>`;
                    });
                    failedDiv.innerHTML = failedHtml;
                } else {
                    failedDiv.innerHTML = '<em>All codes processed successfully!</em>';
                }
                
            } catch (error) {
                showMessage('❌ Error processing JSON data: ' + error.message, 'error');
            }
        }

        // Track dish preparation times
        function updateDishTimes(dishLetter, user) {
            const today = getStandardizedDate();
            const now = new Date();
            const timeKey = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            if (!window.appData.dishTimes[dishLetter]) {
                window.appData.dishTimes[dishLetter] = {
                    firstScan: timeKey,
                    lastScan: timeKey,
                    users: new Set([user]),
                    count: 1
                };
            } else {
                window.appData.dishTimes[dishLetter].lastScan = timeKey;
                window.appData.dishTimes[dishLetter].users.add(user);
                window.appData.dishTimes[dishLetter].count++;
            }
            
            updateDishTimesDisplay();
        }

        function updateDishTimesDisplay() {
            const container = document.getElementById('dishTimesList');
            const dishTimes = window.appData.dishTimes;
            
            if (Object.keys(dishTimes).length === 0) {
                container.innerHTML = '<p>No dish preparation data</p>';
                return;
            }
            
            let html = '';
            Object.keys(dishTimes).sort().forEach(dishLetter => {
                const data = dishTimes[dishLetter];
                const users = Array.from(data.users).join(', ');
                html += `
                    <div class="time-stats">
                        <strong>Dish ${dishLetter}:</strong> 
                        First: ${data.firstScan} | Last: ${data.lastScan} | 
                        Count: ${data.count} | Users: ${users}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // UPDATED Kitchen Scan - Checks active, prepared AND returned bowls
        function kitchenScan(code) {
            const startTime = Date.now();
            const originalCode = code;
            const today = getStandardizedDate();
            
            console.log('🔍 Kitchen scan checking:', originalCode);
            
            // Check if bowl is already ACTIVE
            if (window.appData.activeBowls.some(bowl => bowl.code === originalCode)) {
                return { 
                    message: "❌ Bowl already active: " + originalCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Check if bowl is already PREPARED today
            if (window.appData.preparedBowls.some(bowl => bowl.code === originalCode && bowl.date === today)) {
                return { 
                    message: "❌ Already prepared today: " + originalCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Check if bowl is already RETURNED today
            if (window.appData.returnedBowls.some(bowl => bowl.code === originalCode && bowl.returnDate === today)) {
                return { 
                    message: "❌ Bowl was returned today: " + originalCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // ALL CHECKS PASSED - Create new bowl
            const newBowl = {
                code: originalCode,
                dish: window.appData.dishLetter,
                user: window.appData.user,
                company: "Unknown",
                customer: "Unknown",
                date: today,
                time: new Date().toLocaleTimeString(),
                timestamp: new Date().toISOString(),
                status: 'ACTIVE',
                multipleCustomers: false
            };
            
            window.appData.activeBowls.push(newBowl);
            window.appData.preparedBowls.push({...newBowl, status: 'PREPARED'});
            
            // Update dish times
            updateDishTimes(window.appData.dishLetter, window.appData.user);
            
            window.appData.myScans.push({
                type: 'kitchen',
                code: originalCode,
                dish: window.appData.dishLetter,
                user: window.appData.user,
                timestamp: new Date().toISOString()
            });
            
            window.appData.scanHistory.unshift({
                type: 'kitchen',
                code: originalCode,
                user: window.appData.user,
                timestamp: new Date().toISOString(),
                message: `${window.appData.dishLetter} Prepared: ${originalCode}`
            });
            
            saveToStorage();
            
            return { 
                message: `✅ ${window.appData.dishLetter} Prepared: ${originalCode}`, 
                type: "success",
                responseTime: Date.now() - startTime
            };
        }

        // UPDATED Return Scan - Checks return status to prevent duplicates
        function returnScan(code) {
            const startTime = Date.now();
            const originalCode = code;
            const today = getStandardizedDate();
            
            console.log('🔍 Return scan checking:', originalCode);
            
            // FIRST: Check if already returned today (prevent duplicates)
            if (window.appData.returnedBowls.some(bowl => bowl.code === originalCode && bowl.returnDate === today)) {
                return { 
                    message: "❌ Already returned today: " + originalCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // SECOND: Check prepared bowls (after JSON assignment, bowls are removed from prepared)
            let sourceBowl = null;
            let sourceType = '';
            
            // Check prepared bowls first
            const preparedIndex = window.appData.preparedBowls.findIndex(bowl => bowl.code === originalCode);
            if (preparedIndex !== -1) {
                sourceBowl = window.appData.preparedBowls[preparedIndex];
                sourceType = 'prepared';
                window.appData.preparedBowls.splice(preparedIndex, 1);
            }
            // Then check active bowls
            else {
                const activeIndex = window.appData.activeBowls.findIndex(bowl => bowl.code === originalCode);
                if (activeIndex !== -1) {
                    sourceBowl = window.appData.activeBowls[activeIndex];
                    sourceType = 'active';
                    window.appData.activeBowls.splice(activeIndex, 1);
                }
            }
            
            if (!sourceBowl) {
                return { 
                    message: "❌ Bowl not found in active or prepared: " + originalCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Create returned bowl entry
            const returnedBowl = {
                ...sourceBowl,
                returnedBy: window.appData.user,
                returnDate: today,
                returnTime: new Date().toLocaleTimeString(),
                returnTimestamp: new Date().toISOString(),
                status: 'RETURNED',
                source: sourceType
            };
            
            window.appData.returnedBowls.push(returnedBowl);
            
            window.appData.myScans.push({
                type: 'return',
                code: originalCode,
                user: window.appData.user,
                timestamp: new Date().toISOString()
            });
            
            window.appData.scanHistory.unshift({
                type: 'return',
                code: originalCode,
                user: window.appData.user,
                timestamp: new Date().toISOString(),
                message: `Returned: ${originalCode} (from ${sourceType})`
            });
            
            saveToStorage();
            
            return { 
                message: `✅ Returned: ${originalCode}`, 
                type: "success",
                responseTime: Date.now() - startTime
            };
        }

        // Clear stuck bowls function
        function clearStuckBowls() {
            const today = getStandardizedDate();
            const returnedCodes = window.appData.returnedBowls
                .filter(bowl => bowl.returnDate === today)
                .map(bowl => bowl.code);
            
            let removedActive = 0;
            let removedPrepared = 0;
            
            // Remove from active bowls
            window.appData.activeBowls = window.appData.activeBowls.filter(bowl => {
                if (returnedCodes.includes(bowl.code)) {
                    removedActive++;
                    return false;
                }
                return true;
            });
            
            // Remove from prepared bowls
            window.appData.preparedBowls = window.appData.preparedBowls.filter(bowl => {
                if (returnedCodes.includes(bowl.code)) {
                    removedPrepared++;
                    return false;
                }
                return true;
            });
            
            saveToStorage();
            updateDisplay();
            
            if (removedActive > 0 || removedPrepared > 0) {
                showMessage(`✅ Cleared ${removedActive} active + ${removedPrepared} prepared stuck bowls`, 'success');
            } else {
                showMessage('ℹ️ No stuck bowls found', 'info');
            }
        }

        // Rest of the functions remain the same as your original system
        function startDailyCleanupTimer() {
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 19 && now.getMinutes() === 0) {
                    clearReturnData();
                }
            }, 60000);
        }

        function clearReturnData() {
            const today = getStandardizedDate();
            if (window.appData.lastCleanup === today) return;
            
            window.appData.returnedBowls = [];
            window.appData.lastCleanup = today;
            saveToStorage();
            
            showMessage('✅ Return data cleared for new day', 'success');
            updateDisplay();
        }

        function saveToStorage() {
            try {
                localStorage.setItem('proglove_data', JSON.stringify(window.appData));
            } catch (error) {
                console.log('Storage save note:', error.message);
            }
        }

        function loadFromStorage() {
            try {
                const saved = localStorage.getItem('proglove_data');
                if (saved) {
                    const data = JSON.parse(saved);
                    window.appData = { ...window.appData, ...data };
                    console.log('Data loaded from storage');
                }
            } catch (error) {
                console.log('No previous data found - starting fresh');
            }
        }

        function initializeUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            USERS.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name + (user.role ? ` (${user.role})` : '');
                dropdown.appendChild(option);
            });
        }

        function setMode(mode) {
            window.appData.mode = mode;
            window.appData.user = null;
            window.appData.dishLetter = null;
            window.appData.scanning = false;
            
            document.getElementById('kitchenBtn').classList.toggle('active', mode === 'kitchen');
            document.getElementById('returnBtn').classList.toggle('active', mode === 'return');
            
            document.getElementById('dishSection').classList.toggle('hidden', mode !== 'kitchen');
            document.getElementById('userDropdown').value = '';
            document.getElementById('dishDropdown').value = '';
            document.getElementById('progloveInput').value = '';
            
            loadUsers();
            updateStatsLabels();
            updateDisplay();
            updateLastActivity();
            showMessage(`📱 ${mode.toUpperCase()} mode selected`, 'info');
        }

        function updateStatsLabels() {
            const prepLabel = document.getElementById('prepLabel');
            if (window.appData.mode === 'kitchen') {
                prepLabel.textContent = 'Prepared Today';
            } else {
                prepLabel.textContent = 'Returned Today';
            }
        }

        function loadUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            let usersToShow = [];
            if (window.appData.mode === 'kitchen') {
                usersToShow = USERS.filter(user => user.role === 'Kitchen');
            } else if (window.appData.mode === 'return') {
                usersToShow = USERS.filter(user => user.role === 'Return');
            }
            
            usersToShow.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name;
                dropdown.appendChild(option);
            });
        }

        function selectUser() {
            const dropdown = document.getElementById('userDropdown');
            window.appData.user = dropdown.value;
            
            if (window.appData.user) {
                showMessage(`✅ ${window.appData.user} selected`, 'success');
                if (window.appData.mode === 'kitchen') {
                    document.getElementById('dishSection').classList.remove('hidden');
                    loadDishLetters();
                }
            }
            updateDisplay();
            updateLastActivity();
        }

        function loadDishLetters() {
            const dropdown = document.getElementById('dishDropdown');
            dropdown.innerHTML = '<option value="">-- Select Dish Letter --</option>';
            
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = letter;
                dropdown.appendChild(option);
            });
            
            '1234'.split('').forEach(number => {
                const option = document.createElement('option');
                option.value = number;
                option.textContent = number;
                dropdown.appendChild(option);
            });
        }

        function selectDishLetter() {
            const dropdown = document.getElementById('dishDropdown');
            window.appData.dishLetter = dropdown.value;
            
            if (window.appData.dishLetter) {
                showMessage(`📝 Dish ${window.appData.dishLetter} selected`, 'success');
            }
            updateDisplay();
            updateLastActivity();
        }

        function startScanning() {
            if (!window.appData.user) {
                showMessage('❌ Please select user first', 'error');
                return;
            }
            if (window.appData.mode === 'kitchen' && !window.appData.dishLetter) {
                showMessage('❌ Please select dish letter first', 'error');
                return;
            }
            
            window.appData.scanning = true;
            updateDisplay();
            document.getElementById('progloveInput').focus();
            updateLastActivity();
            showMessage(`🎯 SCANNING ACTIVE - Ready to scan`, 'success');
        }

        function stopScanning() {
            window.appData.scanning = false;
            updateDisplay();
            updateLastActivity();
            showMessage(`⏹ Scanning stopped`, 'info');
        }

        function processScan(code) {
            let result;
            
            if (window.appData.mode === 'kitchen') {
                result = kitchenScan(code);
            } else {
                result = returnScan(code);
            }
            
            document.getElementById('responseTimeValue').textContent = result.responseTime + 'ms';
            showMessage(result.message, result.type);
            
            if (result.type === 'error') {
                document.getElementById('progloveInput').classList.add('error');
                setTimeout(() => document.getElementById('progloveInput').classList.remove('error'), 2000);
            }
            
            updateDisplay();
            updateOvernightStats();
            updateLastActivity();
        }

        // Overnight Statistics and other functions remain the same...
        // [Include all the other functions from your original system here]

        function showMessage(text, type) {
            const element = document.getElementById('feedback');
            element.textContent = text;
            element.className = 'feedback ' + type;
        }

        // Make functions globally available
        window.setMode = setMode;
        window.selectUser = selectUser;
        window.selectDishLetter = selectDishLetter;
        window.startScanning = startScanning;
        window.stopScanning = stopScanning;
        window.processJSONData = processJSONData;
        window.exportActiveBowls = exportActiveBowls;
        window.exportReturnData = exportReturnData;
        window.exportAllData = exportAllData;
        window.clearStuckBowls = clearStuckBowls;
    </script>
</body>
</html>
