<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProGlove Scanner - Secure Single System</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial; background: #1a1a1a; color: white; padding: 10px; }
        .container { max-width: 100%; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        
        .header { background: #4285f4; padding: 15px; text-align: center; border-radius: 10px; }
        
        .card { background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        
        .sync-section { background: #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .sync-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .sync-btn { flex: 1; padding: 12px; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer; }
        .download-btn { background: #4285f4; color: white; }
        .upload-btn { background: #34a853; color: white; }
        .release-btn { background: #f57c00; color: white; }
        .sync-btn:disabled { background: #666; cursor: not-allowed; }
        
        .system-lock { 
            padding: 10px; margin-top: 10px; border-radius: 5px; text-align: center; font-size: 12px;
            background: #444; border-left: 4px solid #f57c00;
        }
        
        .sync-status { 
            padding: 10px; margin-top: 10px; border-radius: 5px; text-align: center; font-size: 12px;
            background: #444; border-left: 4px solid #4285f4;
        }
        .sync-status.success { border-left-color: #34a853; background: #2a2a2a; }
        .sync-status.error { border-left-color: #ea4335; background: #2a2a2a; }
        
        .mode-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
        .mode-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .kitchen-btn { background: #34a853; color: white; }
        .return-btn { background: #ea4335; color: white; }
        .mode-btn.active { box-shadow: 0 0 0 3px white; }
        
        .dropdown { width: 100%; padding: 12px; background: #444; color: white; border: 2px solid #666; border-radius: 6px; font-size: 16px; margin-top: 10px; }
        
        .scan-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        .scan-btn { flex: 1; padding: 15px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .start-btn { background: #34a853; color: white; }
        .stop-btn { background: #ea4335; color: white; }
        .scan-btn:disabled { background: #666; cursor: not-allowed; }
        
        .proglove-input { 
            width: 100%; padding: 15px; font-size: 18px; background: #333; color: white; border: 2px solid #666; border-radius: 8px; 
            margin-bottom: 15px; text-align: center;
        }
        .proglove-input.error { border-color: #ea4335; animation: shake 0.5s; }
        
        .scanning-active { animation: pulse 1.5s infinite; border: 3px solid #34a853; }
        
        .feedback { 
            padding: 12px; margin-top: 10px; border-radius: 6px; text-align: center; font-weight: bold; min-height: 50px; 
            display: flex; align-items: center; justify-content: center;
        }
        .success { background: #34a853; }
        .error { background: #ea4335; }
        .warning { background: #f57c00; }
        .info { background: #4285f4; }
        
        .hidden { display: none; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { background: #333; padding: 15px; border-radius: 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .kitchen-stat { color: #34a853; }
        .return-stat { color: #ea4335; }
        .active-stat { color: #4285f4; }
        .prep-stat { color: #f57c00; }
        
        .response-time { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
        
        .local-data { 
            background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;
            border-left: 4px solid #f57c00;
        }
        
        .upload-info { 
            background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;
            border-left: 4px solid #4285f4;
        }
        
        .cross-team-data { 
            background: #2a2a2a; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 12px;
            border-left: 4px solid #f57c00;
        }
        
        .data-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .data-label { font-weight: bold; }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(52, 168, 83, 0); }
            100% { box-shadow: 0 0 0 0 rgba(52, 168, 83, 0); }
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß§ ProGlove Scanner - Secure System</h1>
            <p>Single System Lock ‚Ä¢ Real-time Error Detection ‚Ä¢ Spreadsheet Sync</p>
        </div>
        
        <!-- System Lock Status -->
        <div class="card">
            <h3>üîí SYSTEM LOCK STATUS</h3>
            <div class="system-lock" id="systemLockStatus">
                üîì System Available - You can download data
            </div>
        </div>

        <!-- Sync Section -->
        <div class="card">
            <h3>üîÑ SYNC WITH GOOGLE SHEETS</h3>
            <div class="sync-section">
                <div class="sync-controls">
                    <button class="sync-btn download-btn" onclick="downloadFromSheets()" id="downloadBtn">
                        üì• DOWNLOAD & LOCK SYSTEM
                    </button>
                    <button class="sync-btn upload-btn" onclick="uploadToSheets()" id="uploadBtn" disabled>
                        üì§ UPLOAD & RELEASE
                    </button>
                    <button class="sync-btn release-btn" onclick="forceReleaseLock()" id="releaseBtn">
                        üîì FORCE RELEASE
                    </button>
                </div>
                <div class="sync-status" id="syncStatus">
                    ‚ö†Ô∏è Download data first to enable error detection
                </div>
                <div class="local-data" id="localDataInfo">
                    <strong>Local Data:</strong> No data downloaded yet
                </div>
                <div class="upload-info" id="uploadInfo">
                    <strong>Upload History:</strong> No uploads yet
                </div>
            </div>
        </div>

        <!-- Mode Selection -->
        <div class="card">
            <h3>üì± SELECT MODE</h3>
            <div class="mode-buttons">
                <button class="mode-btn kitchen-btn" onclick="setMode('kitchen')" id="kitchenBtn">üç≥ KITCHEN</button>
                <button class="mode-btn return-btn" onclick="setMode('return')" id="returnBtn">üîÑ RETURN</button>
            </div>
        </div>
        
        <!-- User Selection -->
        <div class="card">
            <h3>üë§ SELECT USER</h3>
            <select class="dropdown" id="userDropdown" onchange="selectUser()" disabled>
                <option value="">-- Download Data First --</option>
            </select>
        </div>
        
        <!-- Dish Selection -->
        <div class="card hidden" id="dishSection">
            <h3>üìù SELECT DISH LETTER</h3>
            <select class="dropdown" id="dishDropdown" onchange="selectDishLetter()" disabled>
                <option value="">-- Select Dish Letter --</option>
            </select>
        </div>
        
        <!-- Cross-Team Data Section -->
        <div class="card hidden" id="crossTeamDataSection">
            <h3>üìä CROSS-TEAM DATA</h3>
            <div class="cross-team-data" id="crossTeamData">
                Loading cross-team data...
            </div>
        </div>
        
        <!-- Scan Section -->
        <div class="card" id="scanSection">
            <h3>üîç SCANNING</h3>
            <div class="scan-controls">
                <button class="scan-btn start-btn" id="startBtn" onclick="startScanning()" disabled>‚ñ∂ START SCANNING</button>
                <button class="scan-btn stop-btn" id="stopBtn" onclick="stopScanning()" disabled>‚èπ STOP SCANNING</button>
            </div>
            
            <input type="text" class="proglove-input" id="progloveInput" placeholder="Download data first to enable scanning..." disabled>
            
            <!-- Response Time -->
            <div class="response-time">
                Response time: <span id="responseTimeValue">0</span>ms
            </div>
            
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Active Bowls</div>
                    <div class="stat-value active-stat" id="activeCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Prepared Today</div>
                    <div class="stat-value prep-stat" id="prepCount">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">My Scans Today</div>
                    <div class="stat-value kitchen-stat" id="myScansCount">0</div>
                </div>
            </div>
            
            <div class="feedback info" id="feedback">
                üì• Please download latest data first
            </div>
        </div>
    </div>

    <script>
        // ProGlove Scanner - SECURE SINGLE SYSTEM - FINAL VERSION
        let appData = {
            mode: null,
            user: null,
            dishLetter: null,
            scanning: false,
            dataLoaded: false,
            systemLocked: false,
            lockId: null,
            activeData: [],
            preparation: [],
            archive: [],
            companyData: [],
            users: [],
            myScans: [],
            uploadHistory: [],
            lastSync: null
        };

        // ‚ö†Ô∏è UPDATE THIS URL AFTER DEPLOYING GOOGLE APPS SCRIPT ‚ö†Ô∏è
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/YOUR_DEPLOYED_SCRIPT_ID/exec';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadFromStorage();
            checkSystemLock();
            updateDisplay();
            document.getElementById('progloveInput').addEventListener('input', handleScanInput);
        });

        // Check system lock status
        async function checkSystemLock() {
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=checkLock`);
                const data = await response.json();
                
                if (data.locked && data.lockId === appData.lockId) {
                    appData.systemLocked = true;
                    updateLockDisplay(true, "üîí System locked by YOU");
                } else if (data.locked) {
                    appData.systemLocked = false;
                    appData.dataLoaded = false;
                    updateLockDisplay(false, `üîí System locked by ${data.lockedBy} at ${data.lockTime}`);
                } else {
                    appData.systemLocked = false;
                    updateLockDisplay(false, "üîì System Available - You can download data");
                }
            } catch (error) {
                console.error('Lock check error:', error);
                updateLockDisplay(false, "‚ö†Ô∏è Cannot check system status");
            }
        }

        // SECURE DOWNLOAD FROM GOOGLE SHEETS
        async function downloadFromSheets() {
            if (appData.systemLocked) {
                showMessage("‚ùå System is already locked by another user", "error");
                return;
            }

            const btn = document.getElementById('downloadBtn');
            const status = document.getElementById('syncStatus');
            
            btn.disabled = true;
            btn.textContent = "‚è≥ DOWNLOADING...";
            status.textContent = "‚è≥ Downloading data from Google Sheets...";
            
            try {
                // Generate unique lock ID
                const lockId = 'lock_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // Try to acquire lock and get data
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getAllData&lockId=${lockId}`);
                
                if (!response.ok) {
                    throw new Error('Failed to fetch data from Google Sheets');
                }
                
                const data = await response.json();
                
                if (data.error === 'SYSTEM_LOCKED') {
                    throw new Error('System is locked by another user: ' + data.lockedBy);
                }
                
                // Update app data with Google Sheets data
                appData.activeData = data.activeData || [];
                appData.preparation = data.preparation || [];
                appData.archive = data.archive || [];
                appData.companyData = data.companyData || [];
                appData.users = data.users || [];
                appData.systemLocked = true;
                appData.lockId = lockId;
                appData.dataLoaded = true;
                appData.lastSync = new Date().toISOString();
                
                saveToStorage();
                
                status.textContent = `‚úÖ Data loaded! ${appData.activeData.length} active bowls`;
                status.className = "sync-status success";
                updateLockDisplay(true, "üîí System locked by YOU");
                showMessage("‚úÖ Data loaded from Google Sheets! System locked.", "success");
                
            } catch (error) {
                console.error('Download error:', error);
                status.textContent = "‚ùå " + error.message;
                status.className = "sync-status error";
                showMessage("‚ùå " + error.message, "error");
            } finally {
                btn.disabled = false;
                btn.textContent = "üì• DOWNLOAD & LOCK SYSTEM";
                updateDisplay();
            }
        }

        // SECURE UPLOAD TO GOOGLE SHEETS
        async function uploadToSheets() {
            if (!appData.systemLocked || !appData.lockId) {
                showMessage("‚ùå You don't have system lock", "error");
                return;
            }
            
            if (appData.myScans.length === 0) {
                showMessage("‚ÑπÔ∏è No scans to upload", "info");
                return;
            }
            
            const btn = document.getElementById('uploadBtn');
            const status = document.getElementById('syncStatus');
            
            btn.disabled = true;
            btn.textContent = "‚è≥ UPLOADING...";
            status.textContent = `‚è≥ Uploading ${appData.myScans.length} scans...`;
            
            try {
                // Prepare scan data for upload
                const uploadData = {
                    scans: appData.myScans.map(scan => ({
                        type: scan.type,
                        fullVYTCode: scan.code,
                        dishLetter: scan.dish,
                        user: scan.user,
                        date: new Date().toLocaleDateString('en-GB'),
                        time: new Date().toLocaleTimeString(),
                        company: scan.company || "Unknown",
                        customer: scan.customer || "Unknown",
                        department: scan.department || "Unknown"
                    })),
                    lockId: appData.lockId
                };
                
                // Send to Google Sheets
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'uploadScans',
                        ...uploadData
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Failed to upload to Google Sheets');
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Record successful upload
                    appData.uploadHistory.unshift({
                        user: appData.user || "Unknown",
                        timestamp: new Date().toISOString(),
                        scanCount: appData.myScans.length,
                        mode: appData.mode,
                        details: result.details
                    });
                    
                    // Clear scans and release lock
                    appData.myScans = [];
                    appData.systemLocked = false;
                    appData.lockId = null;
                    saveToStorage();
                    
                    status.textContent = `‚úÖ Uploaded! ${result.details.successful} successful. System released.`;
                    status.className = "sync-status success";
                    updateLockDisplay(false, "üîì System Available");
                    showMessage("‚úÖ Scans uploaded! System released.", "success");
                    
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
                
            } catch (error) {
                console.error('Upload error:', error);
                status.textContent = "‚ùå Upload failed - scans saved locally";
                status.className = "sync-status error";
                showMessage("‚ùå Upload failed - scans saved locally", "error");
            } finally {
                btn.disabled = false;
                btn.textContent = "üì§ UPLOAD & RELEASE";
                updateDisplay();
            }
        }

        // Force release lock
        async function forceReleaseLock() {
            try {
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'forceReleaseLock'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    appData.systemLocked = false;
                    appData.lockId = null;
                    saveToStorage();
                    updateLockDisplay(false, "üîì System Released");
                    showMessage("‚úÖ System lock released", "success");
                } else {
                    showMessage("‚ùå Failed to release lock", "error");
                }
            } catch (error) {
                console.error('Force release error:', error);
                showMessage("‚ùå Error releasing lock", "error");
            }
        }

        function updateLockDisplay(locked, message) {
            const lockStatus = document.getElementById('systemLockStatus');
            lockStatus.textContent = message;
            
            const downloadBtn = document.getElementById('downloadBtn');
            downloadBtn.disabled = locked && !appData.systemLocked;
            
            if (locked && !appData.systemLocked) {
                lockStatus.style.borderLeftColor = '#ea4335';
            } else if (locked) {
                lockStatus.style.borderLeftColor = '#34a853';
            } else {
                lockStatus.style.borderLeftColor = '#f57c00';
            }
        }

        function setMode(mode) {
            if (!appData.dataLoaded) {
                showMessage("‚ùå Please download data first", "error");
                return;
            }
            
            appData.mode = mode;
            appData.user = null;
            appData.dishLetter = null;
            appData.scanning = false;
            
            document.getElementById('kitchenBtn').classList.toggle('active', mode === 'kitchen');
            document.getElementById('returnBtn').classList.toggle('active', mode === 'return');
            
            document.getElementById('dishSection').classList.toggle('hidden', mode !== 'kitchen');
            document.getElementById('crossTeamDataSection').classList.remove('hidden');
            document.getElementById('userDropdown').value = '';
            document.getElementById('dishDropdown').value = '';
            document.getElementById('progloveInput').value = '';
            
            loadUsers();
            updateDisplay();
            showMessage(`üì± ${mode.toUpperCase()} mode selected`, 'info');
        }

        function loadUsers() {
            const dropdown = document.getElementById('userDropdown');
            dropdown.innerHTML = '<option value="">-- Select User --</option>';
            
            appData.users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.name;
                option.textContent = user.name + (user.role ? ` (${user.role})` : '');
                dropdown.appendChild(option);
            });
        }

        function selectUser() {
            const dropdown = document.getElementById('userDropdown');
            appData.user = dropdown.value;
            
            if (appData.user) {
                showMessage(`‚úÖ ${appData.user} selected`, 'success');
                if (appData.mode === 'kitchen') {
                    document.getElementById('dishSection').classList.remove('hidden');
                    loadDishLetters();
                }
            }
            updateDisplay();
        }

        function loadDishLetters() {
            const dropdown = document.getElementById('dishDropdown');
            dropdown.innerHTML = '<option value="">-- Select Dish Letter --</option>';
            'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').forEach(letter => {
                const option = document.createElement('option');
                option.value = letter;
                option.textContent = letter;
                dropdown.appendChild(option);
            });
        }

        function selectDishLetter() {
            const dropdown = document.getElementById('dishDropdown');
            appData.dishLetter = dropdown.value;
            
            if (appData.dishLetter) {
                showMessage(`üìù Dish ${appData.dishLetter} selected`, 'success');
            }
            updateDisplay();
        }

        function startScanning() {
            if (!appData.dataLoaded || !appData.user) {
                showMessage('‚ùå Please select user first', 'error');
                return;
            }
            if (appData.mode === 'kitchen' && !appData.dishLetter) {
                showMessage('‚ùå Please select dish letter first', 'error');
                return;
            }
            
            appData.scanning = true;
            updateDisplay();
            document.getElementById('progloveInput').focus();
            showMessage(`üéØ SCANNING ACTIVE - Ready to scan`, 'success');
        }

        function stopScanning() {
            appData.scanning = false;
            updateDisplay();
            showMessage(`‚èπ Scanning stopped`, 'info');
        }

        function handleScanInput(e) {
            if (!appData.scanning) return;
            
            const scanValue = e.target.value.trim();
            if (scanValue.length >= 2) {
                processScan(scanValue);
                setTimeout(() => e.target.value = '', 100);
            }
        }

        function processScan(code) {
            let result;
            
            if (appData.mode === 'kitchen') {
                result = kitchenScan(code);
            } else {
                result = returnScan(code);
            }
            
            document.getElementById('responseTimeValue').textContent = result.responseTime;
            showMessage(result.message, result.type);
            
            if (result.type === 'error') {
                document.getElementById('progloveInput').classList.add('error');
                setTimeout(() => document.getElementById('progloveInput').classList.remove('error'), 2000);
            }
            
            updateDisplay();
        }

        function kitchenScan(code) {
            const startTime = Date.now();
            const fullCode = code.toUpperCase();
            const today = new Date().toLocaleDateString('en-GB');
            
            // FAST LOCAL VALIDATION (no Google Sheets call needed)
            
            // Check if already scanned in this session
            if (appData.myScans.some(scan => scan.code === fullCode)) {
                return { 
                    message: "‚ùå Already scanned in this session: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Check if already prepared today (from preparation sheet)
            if (appData.preparation.some(bowl => bowl[0].includes(fullCode) && bowl[3] === today)) {
                return { 
                    message: "‚ùå Already prepared today: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Check if already in active data (from active sheet)
            if (appData.activeData.some(bowl => bowl[0].includes(fullCode))) {
                return { 
                    message: "‚ùå Already in active data: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Get company data from JSON configuration
            const companyInfo = appData.companyData.find(item => item[0].includes(fullCode));
            const company = companyInfo ? companyInfo[1] : "Unknown";
            const customer = companyInfo ? companyInfo[2] : "Unknown";
            
            // SUCCESS - Add to local scans for upload
            appData.myScans.push({
                type: 'kitchen',
                code: fullCode,
                dish: appData.dishLetter,
                user: appData.user,
                company: company,
                customer: customer,
                timestamp: new Date().toISOString()
            });
            
            saveToStorage();
            return { 
                message: `‚úÖ ${appData.dishLetter} Prepared: ${fullCode} (${company})`, 
                type: "success",
                responseTime: Date.now() - startTime
            };
        }

        function returnScan(code) {
            const startTime = Date.now();
            const fullCode = code.toUpperCase();
            
            // FAST LOCAL VALIDATION (no Google Sheets call needed)
            
            // Check if already scanned in this session
            if (appData.myScans.some(scan => scan.code === fullCode)) {
                return { 
                    message: "‚ùå Already scanned in this session: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Check against active data from Google Sheets
            const activeBowl = appData.activeData.find(bowl => bowl[0].includes(fullCode));
            if (!activeBowl) {
                return { 
                    message: "‚ùå Not in active data: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Check if already returned (in archive)
            if (appData.archive.some(bowl => bowl[0].includes(fullCode))) {
                return { 
                    message: "‚ùå Already returned: " + fullCode, 
                    type: "error",
                    responseTime: Date.now() - startTime
                };
            }
            
            // Get company data
            const companyInfo = appData.companyData.find(item => item[0].includes(fullCode));
            const company = companyInfo ? companyInfo[1] : "Unknown";
            const customer = companyInfo ? companyInfo[2] : "Unknown";
            
            // SUCCESS - Add to local scans for upload
            appData.myScans.push({
                type: 'return',
                code: fullCode,
                user: appData.user,
                company: company,
                customer: customer,
                timestamp: new Date().toISOString(),
                originalData: activeBowl
            });
            
            saveToStorage();
            return { 
                message: `‚úÖ Returned: ${fullCode} (${company})`, 
                type: "success",
                responseTime: Date.now() - startTime
            };
        }

        function updateDisplay() {
            document.getElementById('userDropdown').disabled = !appData.dataLoaded;
            document.getElementById('dishDropdown').disabled = !appData.dataLoaded;
            document.getElementById('uploadBtn').disabled = !appData.dataLoaded || appData.myScans.length === 0 || !appData.systemLocked;
            
            let canScan = appData.dataLoaded && appData.user && !appData.scanning && appData.systemLocked;
            if (appData.mode === 'kitchen') canScan = canScan && appData.dishLetter;
            document.getElementById('startBtn').disabled = !canScan;
            document.getElementById('stopBtn').disabled = !appData.scanning;
            
            const input = document.getElementById('progloveInput');
            if (appData.scanning) {
                document.getElementById('scanSection').classList.add('scanning-active');
                input.placeholder = "Scan VYT code...";
                input.disabled = false;
            } else {
                document.getElementById('scanSection').classList.remove('scanning-active');
                input.placeholder = appData.dataLoaded ? "Click START SCANNING..." : "Download data first...";
                input.disabled = !appData.dataLoaded || !appData.scanning;
            }
            
            document.getElementById('activeCount').textContent = appData.activeData.length;
            document.getElementById('prepCount').textContent = appData.preparation.length;
            document.getElementById('myScansCount').textContent = appData.myScans.length;
            
            const lastSyncTime = appData.lastSync ? new Date(appData.lastSync).toLocaleTimeString() : 'Never';
            document.getElementById('localDataInfo').innerHTML = `
                <strong>Local Data:</strong> 
                ${appData.activeData.length} active ‚Ä¢ 
                ${appData.preparation.length} prepared ‚Ä¢ 
                ${appData.myScans.length} scans ready to upload ‚Ä¢
                Last sync: ${lastSyncTime}
            `;
            
            const uploadInfo = document.getElementById('uploadInfo');
            if (appData.uploadHistory.length === 0) {
                uploadInfo.innerHTML = '<strong>Upload History:</strong> No uploads yet';
            } else {
                let html = '<strong>Upload History:</strong><br>';
                appData.uploadHistory.forEach(record => {
                    const date = new Date(record.timestamp);
                    html += `<div class="data-row">
                        <span class="data-label">‚úÖ ${record.user}</span>
                        <span>${date.toLocaleDateString()}</span>
                        <span>${record.scanCount} scans</span>
                    </div>`;
                });
                uploadInfo.innerHTML = html;
            }
            
            updateCrossTeamData();
        }

        function updateCrossTeamData() {
            const element = document.getElementById('crossTeamData');
            if (!appData.dataLoaded) {
                element.innerHTML = 'Download data first';
                return;
            }
            
            const today = new Date().toLocaleDateString('en-GB');
            const preps = appData.preparation.filter(bowl => bowl[3] === today).length;
            const returns = appData.archive.filter(bowl => bowl[3] === today).length;
            
            if (appData.mode === 'kitchen') {
                element.innerHTML = `
                    <div class="data-row"><span class="data-label">Today's Returns:</span><span>${returns} bowls</span></div>
                    <div class="data-row"><span class="data-label">Active Bowls:</span><span>${appData.activeData.length} bowls</span></div>
                    <div class="data-row"><span class="data-label">My Preparations Today:</span><span>${appData.myScans.filter(s => s.type === 'kitchen').length} bowls</span></div>
                `;
            } else {
                element.innerHTML = `
                    <div class="data-row"><span class="data-label">Today's Preparations:</span><span>${preps} bowls</span></div>
                    <div class="data-row"><span class="data-label">Active Bowls:</span><span>${appData.activeData.length} bowls</span></div>
                    <div class="data-row"><span class="data-label">My Returns Today:</span><span>${appData.myScans.filter(s => s.type === 'return').length} bowls</span></div>
                `;
            }
        }

        function showMessage(text, type) {
            const element = document.getElementById('feedback');
            element.textContent = text;
            element.className = 'feedback ' + type;
        }

        function saveToStorage() {
            localStorage.setItem('proglove_data', JSON.stringify(appData));
        }

        function loadFromStorage() {
            const saved = localStorage.getItem('proglove_data');
            if (saved) {
                const data = JSON.parse(saved);
                appData = { ...appData, ...data };
            }
        }
    </script>
</body>
</html>
